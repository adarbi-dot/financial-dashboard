<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Financial Wellness Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, setDoc, query, orderBy, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    window.firebase = { 
        initializeApp, 
        getAuth, 
        onAuthStateChanged, 
        createUserWithEmailAndPassword, 
        signInWithEmailAndPassword, 
        signOut, 
        getFirestore, 
        collection, 
        onSnapshot, 
        addDoc, 
        doc, 
        deleteDoc, 
        setDoc, 
        query, 
        orderBy, 
        updateDoc, 
        writeBatch 
    };
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .chat-bubble { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px ); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="bg-slate-900 font-inter text-gray-200">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    // --- SVG ICON COMPONENTS ---
    const DollarSign = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>;
    const Loader2 = ({ className } ) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>;
    const Trash2 = ({ className } ) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>;
    const Sparkles = ({ className } ) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 1v4"></path><path d="M17.65 6.35l-2.79 2.79"></path><path d="M21 12h-4"></path><path d="M17.65 17.65l-2.79-2.79"></path><path d="M12 21v-4"></path><path d="M6.35 17.65l2.79-2.79"></path><path d="M3 12h4"></path><path d="M6.35 6.35l2.79 2.79"></path></svg>;
    const Landmark = ({ className } ) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="3" y1="22" x2="21" y2="22"></line><path d="M6 18v-8"></path><path d="M10 18v-4"></path><path d="M14 18v-6"></path><path d="M18 18V2"></path><path d="M6 10l-4 4v7h20v-7l-4-4"></path></svg>;
    const Wallet = ({ className } ) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3v2a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V3"></path><path d="M16 17a2 2 0 0 0 0-4h-4a2 2 0 0 0 0 4"></path></svg>;
    const BarChart = ({ className } ) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>;
    const Edit = ({ className } ) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>;
    const LogOut = ({ className } ) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>;

    // --- GLOBAL HELPER DATA ---
    const exchangeRates = { 'USD': 1, 'AED': 3.67, 'EUR': 1.08, 'GBP': 1.25, 'JPY': 0.0065, 'CAD': 0.73, 'AUD': 0.67, 'CNY': 0.14, 'SAR': 0.27 };
    const categories = {
      'Personal Expense': ['Groceries', 'Rent', 'Utilities', 'Entertainment', 'Transportation', 'Subscriptions', 'Other Personal'],
      'Business Expense': ['Software', 'Freelance Tools', 'Co-working Space', 'Marketing', 'Education', 'Other Business'],
      'Income': ['Client Work', 'Bonus', 'Tips', 'Salary', 'Other Income']
    };
    const currencies = [ { code: 'USD', symbol: '$' }, { code: 'AED', symbol: 'د.إ' }, { code: 'EUR', symbol: '€' }, { code: 'GBP', symbol: '£' } ];
    const getSymbol = (code ) => currencies.find(c => c.code === code)?.symbol || '';

// --- END OF PART 1 ---
     // --- CHILD COMPONENTS ---
    const MortgageCalculator = () => {
      const [principal, setPrincipal] = useState(250000);
      const [interestRate, setInterestRate] = useState(4.5);
      const [loanTerm, setLoanTerm] = useState(30);
      const [extraPayment, setExtraPayment] = useState(0);
      const [results, setResults] = useState(null);

      const calculateMortgage = () => {
        const P = parseFloat(principal);
        const R = parseFloat(interestRate) / 100 / 12;
        const N = parseFloat(loanTerm) * 12;
        const extraPmt = parseFloat(extraPayment) || 0;
        
        if (P <= 0 || R <= 0 || N <= 0) { setResults(null); return; }

        const monthlyPayment = P * (R * Math.pow(1 + R, N)) / (Math.pow(1 + R, N) - 1);
        
        let totalInterestPaid = (monthlyPayment * N) - P;
        
        let totalInterestPaidWithExtra = 0;
        let termWithExtra = 0;
        let tempPrincipalExtra = P;
        if (extraPmt > 0) {
            let tempMonthsExtra = 0;
            while (tempPrincipalExtra > 0) {
              const interestPortion = tempPrincipalExtra * R;
              const principalPortion = (monthlyPayment + extraPmt) - interestPortion;
              tempPrincipalExtra -= principalPortion;
              totalInterestPaidWithExtra += interestPortion;
              tempMonthsExtra++;
              if (tempMonthsExtra > N * 2) break; // Safety break
            }
            termWithExtra = tempMonthsExtra;
        } else {
            totalInterestPaidWithExtra = totalInterestPaid;
            termWithExtra = N;
        }

        setResults({
          monthlyPayment: monthlyPayment.toFixed(2),
          totalInterestPaid: totalInterestPaid.toFixed(2),
          totalInterestSaved: (totalInterestPaid - totalInterestPaidWithExtra).toFixed(2),
          totalMonthsSaved: N - termWithExtra,
          termWithExtra: Math.ceil(termWithExtra / 12)
        });
      };

      return (
        <div className="bg-slate-800 rounded-2xl p-6 shadow-xl lg:col-span-1">
          <h2 className="text-2xl font-bold mb-6 text-gray-100 flex items-center"><Landmark className="w-7 h-7 mr-2" />Mortgage Payoff Calculator</h2>
          <div className="space-y-4">
            <div><label className="block text-sm font-medium mb-1 text-slate-400">Principal ($)</label><input type="number" value={principal} onChange={(e) => setPrincipal(e.target.value)} className="w-full p-3 rounded-lg bg-slate-700 border border-slate-600 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500"/></div>
            <div><label className="block text-sm font-medium mb-1 text-slate-400">Interest Rate (%)</label><input type="number" value={interestRate} onChange={(e) => setInterestRate(e.target.value)} step="0.01" className="w-full p-3 rounded-lg bg-slate-700 border border-slate-600 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500"/></div>
            <div><label className="block text-sm font-medium mb-1 text-slate-400">Loan Term (Years)</label><input type="number" value={loanTerm} onChange={(e) => setLoanTerm(e.target.value)} className="w-full p-3 rounded-lg bg-slate-700 border border-slate-600 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500"/></div>
            <div><label className="block text-sm font-medium mb-1 text-slate-400">Extra Monthly Payment ($)</label><input type="number" value={extraPayment} onChange={(e) => setExtraPayment(e.target.value)} step="0.01" className="w-full p-3 rounded-lg bg-slate-700 border border-slate-600 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500"/></div>
            <button onClick={calculateMortgage} className="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors shadow-lg">Calculate Mortgage</button>
            {results && (<div className="mt-4 p-4 bg-slate-700 rounded-lg space-y-2"><p className="font-semibold text-green-400">Monthly Payment: ${results.monthlyPayment}</p><p className="text-sm text-slate-300">Total Interest (without extra): ${results.totalInterestPaid}</p><p className="text-sm text-slate-300">New Term: {results.termWithExtra} years</p><p className="font-bold text-lg text-green-300">Total Interest Saved: ${results.totalInterestSaved}</p><p className="font-bold text-lg text-green-300">Months Saved: {results.totalMonthsSaved}</p></div>)}
          </div>
        </div>
      );
    };

    const AiMortgageInsights = () => {
        const [statementText, setStatementText] = useState('');
        const [insights, setInsights] = useState(null);
        const [isAnalyzing, setIsAnalyzing] = useState(false);
        const [error, setError] = useState('');

        const handleAnalyzeStatement = async () => {
            if (!statementText.trim()) { setError('Please paste your mortgage statement details.'); return; }
            setError(''); setInsights(null); setIsAnalyzing(true);
             try {
                const apiKey = "AIzaSyCEwNa6knQpuCV_eLgKLr7m-88ufWP8484"; // Your API Key
                const prompt = `Extract transaction data from the following text and return ONLY a valid JSON array. Do not include any other text or explanations. For each object, include: 'date' (YYYY-MM-DD), 'description' (string), 'amount' (number), 'type' ('Income', 'Personal Expense', or 'Business Expense'), 'category' (choose from: ${Object.values(categories).flat().join(', ')}), and 'currency' (e.g., 'USD', 'AED', 'EUR').\n\nText: ${pastedText}`;
                const payload = { contents: [{ role: 'user', parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload ) });
                if (!response.ok) { throw new Error('API request failed'); }

                const result = await response.json();
                
                // --- NEW, SMARTER PARSING LOGIC ---
                let jsonText = result.candidates[0].content.parts[0].text;
                
                // Find the start of the JSON array '[' and the end ']'
                const startIndex = jsonText.indexOf('[');
                const endIndex = jsonText.lastIndexOf(']');
                
                if (startIndex === -1 || endIndex === -1) {
                    throw new Error("AI response did not contain a valid JSON array.");
                }

                // Extract only the JSON part of the string
                const jsonArrayString = jsonText.substring(startIndex, endIndex + 1);
                const parsedTransactions = JSON.parse(jsonArrayString);
                // --- END OF SMARTER PARSING LOGIC ---

                const batch = window.firebase.writeBatch(db);
                const transactionsCollectionRef = window.firebase.collection(db, `users/${userId}/transactions`);
                parsedTransactions.forEach(transaction => {
                    if (transaction.description && transaction.amount > 0) {
                        const newTransactionRef = window.firebase.doc(transactionsCollectionRef);
                        batch.set(newTransactionRef, transaction);
                    }
                });
                await batch.commit();
                setMessage(`Successfully added ${parsedTransactions.length} transactions!`);
                setPastedText('');
            } catch (error) {
                console.error("Error during parsing:", error);
                setMessage("Failed to parse text. Please check the format and try again.");
            } finally {
                setPendingTransactions([]);
                setIsParsing(false);
            }

        return (
            <div className="bg-slate-800 rounded-2xl p-6 shadow-xl lg:col-span-1">
                <h2 className="text-2xl font-bold mb-6 text-gray-100 flex items-center"><Sparkles className="w-7 h-7 mr-2" />AI Mortgage Insights</h2>
                <div className="space-y-4">
                    <p className="text-sm text-slate-400">Paste your mortgage statement details below for personalized payoff strategies.</p>
                    <textarea value={statementText} onChange={(e) => setStatementText(e.target.value)} rows="6" placeholder="Paste your mortgage principal, interest rate, and term here..." className="w-full p-3 rounded-lg bg-slate-700 border border-slate-600 text-gray-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    <button onClick={handleAnalyzeStatement} disabled={isAnalyzing} className={`w-full font-bold py-3 px-6 rounded-lg transition-colors shadow-lg ${isAnalyzing ? 'bg-blue-800 text-slate-500 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'}`}>{isAnalyzing ? ( <Loader2 className="animate-spin inline-block mr-2" /> ) : ( 'Get Mortgage Insights' )}</button>
                    {error && <p className="text-red-400 text-sm text-center">{error}</p>}
                    {insights && (<div className="mt-4 p-4 bg-slate-700 rounded-lg space-y-2"><p className="text-green-400 font-semibold">Your Personalized Plan:</p><p className="whitespace-pre-wrap text-slate-300">{insights}</p></div>)}
                </div>
            </div>
        );
    };

    const SpendingChart = ({ transactions, baseCurrency }) => {
        const canvasRef = useRef(null);
        const chartRef = useRef(null);
        const categorySpending = useMemo(() => {
            const spending = {};
            transactions.forEach(t => {
                if (t.type !== 'Income') {
                    const convertedAmount = t.amount * (exchangeRates[t.currency] / exchangeRates[baseCurrency]);
                    spending[t.category] = (spending[t.category] || 0) + convertedAmount;
                }
            });
            return spending;
        }, [transactions, baseCurrency]);

        useEffect(() => {
            if (!canvasRef.current) return;
            const ctx = canvasRef.current.getContext('2d');
            if (chartRef.current) { chartRef.current.destroy(); }
            if (Object.keys(categorySpending).length === 0) { return; }
            chartRef.current = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(categorySpending),
                    datasets: [{ data: Object.values(categorySpending), backgroundColor: ['#06b6d4', '#6366f1', '#a855f7', '#ec4899', '#f43f5e', '#ef4444', '#f97316', '#eab308', '#22c55e', '#10b981'] }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: '#94a3b8' } }, tooltip: { callbacks: { label: (context) => `${context.label || ''}: ${getSymbol(baseCurrency)}${context.parsed.toFixed(2)}` } } } }
            });
        }, [categorySpending, baseCurrency]);

        return (
            <div className="bg-slate-800 rounded-2xl p-6 shadow-xl flex-grow flex flex-col items-center">
                <h2 className="text-2xl font-bold mb-6 text-gray-100 flex items-center"><BarChart className="w-7 h-7 mr-2"/>Spending Breakdown</h2>
                <div className="relative w-full h-80"><canvas ref={canvasRef}></canvas></div>
            </div>
        );
    };

    // --- AUTHENTICATION PAGE ---
    const LoginPage = ({ auth }) => {
        const [isLogin, setIsLogin] = useState(true);
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [error, setError] = useState('');
        const [isLoading, setIsLoading] = useState(false);

        const handleAuthAction = async (e) => {
            e.preventDefault();
            if (!email || !password) { setError('Please enter both email and password.'); return; }
            setError(''); setIsLoading(true);
            try {
                if (isLogin) {
                    await window.firebase.signInWithEmailAndPassword(auth, email, password);
                } else {
                    await window.firebase.createUserWithEmailAndPassword(auth, email, password);
                }
            } catch (err) {
                if (err.code === 'auth/wrong-password' || err.code === 'auth/user-not-found' || err.code === 'auth/invalid-credential') {
                    setError('Invalid email or password.');
                } else if (err.code === 'auth/email-already-in-use') {
                    setError('An account already exists with this email. Please log in.');
                } else {
                    setError('An error occurred. Please try again.');
                    console.error("Firebase Auth Error:", err);
                }
            } finally {
                setIsLoading(false);
            }
        };

        return (
            <div className="min-h-screen flex items-center justify-center bg-slate-900 p-4">
                <div className="w-full max-w-md p-8 space-y-6 bg-slate-800 rounded-2xl shadow-2xl">
                    <div className="text-center">
                        <h1 className="text-4xl font-extrabold text-white">Financial Dashboard</h1>
                        <p className="text-slate-400 mt-2">{isLogin ? 'Welcome back, log in to continue' : 'Create an account to get started'}</p>
                    </div>
                    <form onSubmit={handleAuthAction} className="space-y-6">
                        <div><label className="block text-sm font-medium mb-1 text-slate-400">Email Address</label><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} required className="w-full p-3 rounded-lg bg-slate-700 border border-slate-600 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="you@example.com" /></div>
                        <div><label className="block text-sm font-medium mb-1 text-slate-400">Password</label><input type="password" value={password} onChange={(e) => setPassword(e.target.value)} required className="w-full p-3 rounded-lg bg-slate-700 border border-slate-600 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••••••" /></div>
                        {error && <p className="text-red-400 text-sm text-center">{error}</p>}
                        <div><button type="submit" disabled={isLoading} className={`w-full font-bold py-3 px-6 rounded-lg transition-colors shadow-lg ${isLoading ? 'bg-blue-800 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}`}>{isLoading ? <Loader2 className="animate-spin inline-block"/> : (isLogin ? 'Login' : 'Sign Up')}</button></div>
                    </form>
                    <p className="text-center text-sm text-slate-400">{isLogin ? "Don't have an account? " : "Already have an account? "}<button onClick={() => { setIsLogin(!isLogin); setError(''); }} className="font-medium text-blue-400 hover:underline">{isLogin ? 'Sign Up' : 'Login'}</button></p>
                </div>
            </div>
        );
    };

// --- END OF PART 2 ---
     // --- MAIN DASHBOARD COMPONENT ---
    const FinancialDashboard = ({ user, db, auth }) => {
        // State for data
        const [transactions, setTransactions] = useState([]);
        const [goals, setGoals] = useState([]);
        const [budgets, setBudgets] = useState({});
        
        // State for forms
        const [date, setDate] = useState('');
        const [description, setDescription] = useState('');
        const [amount, setAmount] = useState('');
        const [type, setType] = useState('Personal Expense');
        const [category, setCategory] = useState(categories['Personal Expense'][0]);
        const [currency, setCurrency] = useState('USD');
        const [editingTransactionId, setEditingTransactionId] = useState(null);
        
        // State for UI feedback
        const [message, setMessage] = useState('');
        const [baseCurrency, setBaseCurrency] = useState('USD');
        const userId = user.uid;

        // State for Goals form
        const [newGoalName, setNewGoalName] = useState('');
        const [newGoalTarget, setNewGoalTarget] = useState('');

        // State for Budgets form
        const [budgetInput, setBudgetInput] = useState('');
        const [selectedBudgetCategory, setSelectedBudgetCategory] = useState('Groceries');

        // State and functions for AI features
        const [pastedText, setPastedText] = useState('');
        const [isParsing, setIsParsing] = useState(false);
        const [chatHistory, setChatHistory] = useState([]);
        const [chatInput, setChatInput] = useState('');
        const [isChatting, setIsChatting] = useState(false);
        const chatEndRef = useRef(null);

        // State for Optimistic UI
        const [pendingTransactions, setPendingTransactions] = useState([]);

        // --- DATA HANDLING & FIRESTORE ---
        useEffect(() => {
            if (!db || !userId) return;
            const listeners = [];
            const transactionsRef = window.firebase.collection(db, `users/${userId}/transactions`);
            const qTransactions = window.firebase.query(transactionsRef);
            listeners.push(window.firebase.onSnapshot(qTransactions, (snapshot) => { 
                const fetchedTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                fetchedTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                setTransactions(fetchedTransactions);
            }, (error) => console.error("Error fetching transactions:", error)));
            
            const goalsRef = window.firebase.collection(db, `users/${userId}/goals`);
            listeners.push(window.firebase.onSnapshot(goalsRef, (snapshot) => { setGoals(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); }, (error) => console.error("Error fetching goals:", error)));
            
            const budgetsRef = window.firebase.collection(db, `users/${userId}/budgets`);
            listeners.push(window.firebase.onSnapshot(budgetsRef, (snapshot) => { const fetchedBudgets = {}; snapshot.docs.forEach(doc => { fetchedBudgets[doc.id] = doc.data().amount; }); setBudgets(fetchedBudgets); }, (error) => console.error("Error fetching budgets:", error)));
            
            return () => listeners.forEach(unsubscribe => unsubscribe());
        }, [db, userId]);

        // --- CRUD FUNCTIONS ---
        const handleAddOrUpdateTransaction = async (e) => {
            e.preventDefault();
            if (!date || !description || !amount || parseFloat(amount) <= 0) { setMessage('Please fill out all fields.'); return; }
            const transactionData = { date, description, amount: parseFloat(amount), type, category, currency };
            try {
                if (editingTransactionId) {
                    await window.firebase.updateDoc(window.firebase.doc(db, `users/${userId}/transactions`, editingTransactionId), transactionData);
                    setMessage('Transaction updated!');
                    setEditingTransactionId(null);
                } else {
                    await window.firebase.addDoc(window.firebase.collection(db, `users/${userId}/transactions`), transactionData);
                    setMessage('Transaction added!');
                }
                setDate('');
                setDescription('');
                setAmount('');
                setCurrency('USD');
                setType('Personal Expense');
                setCategory(categories['Personal Expense'][0]);
            } catch (err) {
                console.error(err);
                setMessage('Failed to save transaction.');
            }
        };
        const handleDeleteTransaction = async (id) => { try { await window.firebase.deleteDoc(window.firebase.doc(db, `users/${userId}/transactions`, id)); setMessage("Transaction deleted."); } catch (err) { console.error(err); setMessage("Failed to delete transaction."); } };
        const handleEditTransaction = (t) => { setEditingTransactionId(t.id); setDate(t.date); setDescription(t.description); setAmount(t.amount); setType(t.type); setCategory(t.category); setCurrency(t.currency); };
        const handleAddGoal = async (e) => { e.preventDefault(); if (!newGoalName.trim() || !newGoalTarget || parseFloat(newGoalTarget) <= 0) { setMessage('Please enter a valid goal.'); return; } try { await window.firebase.addDoc(window.firebase.collection(db, `users/${userId}/goals`), { name: newGoalName, targetAmount: parseFloat(newGoalTarget), currentAmount: 0 }); setMessage('Goal added!'); setNewGoalName(''); setNewGoalTarget(''); } catch (err) { console.error(err); setMessage('Failed to add goal.'); } };
        const handleDeleteGoal = async (id) => { try { await window.firebase.deleteDoc(window.firebase.doc(db, `users/${userId}/goals`, id)); setMessage("Goal deleted."); } catch (err) { console.error(err); setMessage("Failed to delete goal."); } };
        const handleAddBudget = async (e) => { e.preventDefault(); if (!selectedBudgetCategory || !budgetInput || parseFloat(budgetInput) <= 0) { setMessage('Please enter a valid budget.'); return; } try { await window.firebase.setDoc(window.firebase.doc(db, `users/${userId}/budgets`, selectedBudgetCategory), { amount: parseFloat(budgetInput) }); setMessage(`Budget for ${selectedBudgetCategory} set!`); setBudgetInput(''); } catch (err) { console.error(err); setMessage('Failed to set budget.'); } };
        const handleSignOut = async () => { try { await window.firebase.signOut(auth); } catch (error) { console.error("Error signing out:", error); } };

        // --- AI & PARSING FUNCTIONS ---
        const handleParseText = async () => {
            if (!pastedText.trim()) { setMessage('Please paste text to parse.'); return; }
            const optimisticId = `pending-${Date.now()}`;
            const ghostTransaction = { id: optimisticId, description: "Analyzing with AI, please wait...", isPending: true };
            setPendingTransactions([ghostTransaction]);
            setIsParsing(true);
            setMessage('Importing transactions...');
            try {
                const apiKey = "AIzaSyCEwNa6knQpuCV_eLgKLr7m-88ufWP8484";
                const prompt = `You are an expert data extractor. Extract transaction data from the following text and return ONLY a valid JSON array. Do not include any other text or explanations. For each object, include: 'date' (YYYY-MM-DD), 'description' (string), 'amount' (number), 'type' (must be 'Income', 'Personal Expense', or 'Business Expense'), 'category' (choose from: ${Object.values(categories).flat().join(', ')}), and 'currency' (This is very important. Look for currency symbols like $ or currency codes like AED, EUR, USD, etc., next to the amount. If you find one, use that code. If no currency is specified, default to 'USD'.). Text: ${pastedText}`;
                const payload = { contents: [{ role: 'user', parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload ) });
                if (!response.ok) { throw new Error('API request failed'); }
                const result = await response.json();
                let jsonText = result.candidates[0].content.parts[0].text;
                const startIndex = jsonText.indexOf('[');
                const endIndex = jsonText.lastIndexOf(']');
                if (startIndex === -1 || endIndex === -1) { throw new Error("AI response did not contain a valid JSON array."); }
                const jsonArrayString = jsonText.substring(startIndex, endIndex + 1);
                const parsedTransactions = JSON.parse(jsonArrayString);
                const batch = window.firebase.writeBatch(db);
                const transactionsCollectionRef = window.firebase.collection(db, `users/${userId}/transactions`);
                parsedTransactions.forEach(transaction => {
                    if (transaction.description && transaction.amount > 0) {
                        const newTransactionRef = window.firebase.doc(transactionsCollectionRef);
                        batch.set(newTransactionRef, transaction);
                    }
                });
                await batch.commit();
                setMessage(`Successfully imported ${parsedTransactions.length} transactions!`);
                setPastedText('');
            } catch (error) {
                console.error("Error during parsing:", error);
                setMessage("Failed to import transactions. Please check the format and try again.");
            } finally {
                setPendingTransactions([]);
                setIsParsing(false);
            }
        };

        const handleSendMessage = async () => {
            if (isChatting || !chatInput.trim()) return;
            const userMessage = { role: 'user', content: chatInput };
            const newChatHistory = [...chatHistory, userMessage];
            setChatHistory(newChatHistory);
            setChatInput('');
            setIsChatting(true);
            try {
                const apiKey = "AIzaSyCEwNa6knQpuCV_eLgKLr7m-88ufWP8484";
                const financialDataSummary = `Total Income: ${totals.income} ${baseCurrency}, Total Expenses: ${totals.expense} ${baseCurrency}, Recent Transactions: ${JSON.stringify(transactions.slice(0, 5))}`;
                const prompt = `You are an expert financial coach. Based on the user's question and their financial data, provide clear, actionable advice. Analyze their spending, income, and goals to help them manage debt or improve their financial health.\n\nFinancial Data Summary: ${financialDataSummary}\n\nConversation History:\n${newChatHistory.map(msg => `${msg.role}: ${msg.content}`).join('\n')}\n\nYour Answer:`;
                const payload = { contents: [{ role: 'user', parts: [{ text: prompt }] }] };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload ) });
                if (!response.ok) { throw new Error('API request failed'); }
                const result = await response.json();
                const aiMessage = { role: 'assistant', content: result.candidates[0].content.parts[0].text.replace(/\*\*/g, '') };
                setChatHistory(prev => [...prev, aiMessage]);
            } catch (error) { console.error("Error in chat:", error); const errorMessage = { role: 'assistant', content: 'Sorry, I encountered an error. Please try again.' }; setChatHistory(prev => [...prev, errorMessage]);
            } finally { setIsChatting(false); }
        };

        useEffect(() => { if (chatEndRef.current) { chatEndRef.current.scrollTop = chatEndRef.current.scrollHeight; } }, [chatHistory]);

        // --- DERIVED STATE & FORMATTERS ---
        const formatDate = (dateString) => new Date(dateString).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' });
        const totals = useMemo(() => { let totalIncome = 0, totalExpense = 0; const budgetProgress = {}; Object.keys(budgets).forEach(cat => { budgetProgress[cat] = { spent: 0, budget: budgets[cat] }; }); transactions.forEach(t => { const convertedAmount = t.amount * (exchangeRates[t.currency] / exchangeRates[baseCurrency]); if (t.type === 'Income') { totalIncome += convertedAmount; } else { totalExpense += convertedAmount; if (budgetProgress[t.category]) { budgetProgress[t.category].spent += convertedAmount; } } }); return { income: totalIncome.toFixed(2), expense: totalExpense.toFixed(2), net: (totalIncome - totalExpense).toFixed(2), budgetProgress }; }, [transactions, budgets, baseCurrency]);
        const getGoalsProgress = (goal) => ((Math.min(goal.currentAmount / goal.targetAmount, 1)) * 100).toFixed(0);

// --- END OF PART 3 ---
    // --- APP GATEKEEPER COMPONENT ---
    const App = () => {
        const [user, setUser] = useState(null);
        const [auth, setAuth] = useState(null);
        const [db, setDb] = useState(null);
        const [isInitializing, setIsInitializing] = useState(true);
        const [firebaseError, setFirebaseError] = useState(null);

        useEffect(() => {
            const firebaseConfig = {
              apiKey: "AIzaSyCEwNa6knQpuCV_eLgKLr7m-88ufWP8484",
              authDomain: "financial-wellness-dashboard.firebaseapp.com",
              projectId: "financial-wellness-dashboard",
              storageBucket: "financial-wellness-dashboard.appspot.com",
              messagingSenderId: "599378817258",
              appId: "1:599378817258:web:95841307d6960986f36793",
              measurementId: "G-4TZ4BKTP9B"
            };

            try {
                const app = window.firebase.initializeApp(firebaseConfig);
                const authInstance = window.firebase.getAuth(app);
                const dbInstance = window.firebase.getFirestore(app);
                setAuth(authInstance);
                setDb(dbInstance);

                const unsubscribe = window.firebase.onAuthStateChanged(authInstance, (currentUser) => {
                    setUser(currentUser);
                    setIsInitializing(false);
                });

                return () => unsubscribe();
            } catch (error) {
                console.error("FATAL: Error initializing Firebase:", error);
                setFirebaseError("Could not connect to Firebase. Please check the configuration.");
                setIsInitializing(false);
            }
        }, []);

        if (isInitializing) {
            return (<div className="flex items-center justify-center min-h-screen bg-slate-900 text-gray-400"><Loader2 className="w-10 h-10 animate-spin mr-3"/><p>Connecting to services...</p></div>);
        }

        if (firebaseError) {
            return (<div className="flex items-center justify-center min-h-screen bg-slate-900 text-red-400"><p>{firebaseError}</p></div>);
        }

        return (<> {user ? (<FinancialDashboard user={user} db={db} auth={auth} />) : (<LoginPage auth={auth} />)} </>);
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>

