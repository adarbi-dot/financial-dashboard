<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clarity - Financial Wellness Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- React and Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap">
    <style>
        body {
            font-family: 'DM Sans', sans-serif;
        }
        .gradient-text {
            background: linear-gradient(to right, #38bdf8, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .card-hover {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        }
        .progress-bar {
            background: linear-gradient(90deg, #38bdf8, #a78bfa);
        }
        .section-content {
            display: none;
        }
        .section-content.active {
            display: block;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-300">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Helper Functions and Data ---
        const exchangeRates = { 'USD': 1, 'AED': 3.67, 'EUR': 1.08, 'GBP': 1.25 };
        const categories = {
            'Personal Expense': ['Groceries', 'Rent', 'Utilities', 'Entertainment', 'Transportation', 'Subscriptions', 'Other Personal'],
            'Business Expense': ['Software', 'Freelance Tools', 'Co-working Space', 'Marketing', 'Education', 'Other Business'],
            'Income': ['Client Work', 'Bonus', 'Tips', 'Salary', 'Other Income']
        };
        const currencies = [ { code: 'USD', symbol: '$' }, { code: 'AED', symbol: 'ÿØ.ÿ•' }, { code: 'EUR', symbol: '‚Ç¨' }, { code: 'GBP', symbol: '¬£' } ];
        const getSymbol = (code) => currencies.find(c => c.code === code)?.symbol || '';
        const formatDate = (dateString) => new Date(dateString).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

        // --- Login Page Component ---
        const LoginPage = ({ auth, setError, setMessage }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');

            const handleAuthAction = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    if (isLogin) {
                        await firebase.auth().signInWithEmailAndPassword(email, password);
                    } else {
                        await firebase.auth().createUserWithEmailAndPassword(email, password);
                    }
                } catch (error) {
                    setError(error.message);
                }
            };

            return (
                <div className="flex items-center justify-center min-h-screen bg-slate-950">
                    <div className="w-full max-w-md p-8 space-y-6 bg-slate-900 rounded-2xl shadow-2xl">
                        <div className="text-center">
                            <h1 className="text-4xl font-extrabold gradient-text">Clarity</h1>
                            <p className="text-slate-400 mt-2">{isLogin ? 'Welcome back, log in to continue' : 'Create an account to get started'}</p>
                        </div>
                        <form onSubmit={handleAuthAction} className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium mb-1 text-slate-400">Email Address</label>
                                <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} required className="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 focus:ring-2 focus:ring-blue-500 text-white" placeholder="you@example.com" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1 text-slate-400">Password</label>
                                <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} required className="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 focus:ring-2 focus:ring-blue-500 text-white" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                            </div>
                            <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">{isLogin ? 'Login' : 'Sign Up'}</button>
                        </form>
                        <p className="text-center text-sm text-slate-400">{isLogin ? "Don't have an account? " : "Already have an account? "}<button onClick={() => { setIsLogin(!isLogin); setError(''); }} className="font-medium text-blue-400 hover:underline">{isLogin ? 'Sign Up' : 'Login'}</button></p>
                    </div>
                </div>
            );
        };

        // --- Main Application Component ---
        const FinancialDashboard = ({ user, db, auth }) => {
            const [transactions, setTransactions] = useState([]);
            const [baseCurrency, setBaseCurrency] = useState(localStorage.getItem('userBaseCurrency') || 'USD');
            const [activeSection, setActiveSection] = useState('dashboard');
            const [pastedText, setPastedText] = useState('');
            const [isParsing, setIsParsing] = useState(false);
            const [pendingTransactions, setPendingTransactions] = useState([]);
            const [message, setMessage] = useState('');
            const chatEndRef = useRef(null);
            const [chatHistory, setChatHistory] = useState([]);
            const [chatInput, setChatInput] = useState('');
            const [isChatting, setIsChatting] = useState(false);
            
            useEffect(() => {
                if (!db || !user) return;
                const transactionsRef = firebase.firestore().collection(`users/${user.uid}/transactions`);
                const unsubscribe = transactionsRef.onSnapshot((snapshot) => {
                    const fetched = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    fetched.sort((a, b) => new Date(b.date) - new Date(a.date));
                    setTransactions(fetched);
                });
                return () => unsubscribe();
            }, [db, user]);

            useEffect(() => {
                if (chatEndRef.current) {
                    chatEndRef.current.scrollTop = chatEndRef.current.scrollHeight;
                }
            }, [chatHistory]);

            const totals = useMemo(() => {
                let totalIncome = 0;
                let totalExpense = 0;
                transactions.forEach(t => {
                    const rate = exchangeRates[t.currency] || 1;
                    const baseRate = exchangeRates[baseCurrency] || 1;
                    const convertedAmount = t.amount * (rate / baseRate);
                    if (t.type === 'Income') totalIncome += convertedAmount;
                    else totalExpense += convertedAmount;
                });
                return {
                    income: totalIncome.toFixed(2),
                    expense: totalExpense.toFixed(2),
                    net: (totalIncome - totalExpense).toFixed(2)
                };
            }, [transactions, baseCurrency]);

            const recentTransactions = transactions.slice(0, 5);
            const userName = user.email.split('@')[0];
            const currencySymbol = getSymbol(baseCurrency);

            const categoryBreakdown = useMemo(() => {
                const breakdown = {};
                transactions.forEach(t => {
                    if (t.type !== 'Income') {
                        const rate = exchangeRates[t.currency] || 1;
                        const baseRate = exchangeRates[baseCurrency] || 1;
                        const convertedAmount = t.amount * (rate / baseRate);
                        breakdown[t.subcategory] = (breakdown[t.subcategory] || 0) + convertedAmount;
                    }
                });
                return Object.entries(breakdown)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5);
            }, [transactions, baseCurrency]);

            const handleSignOut = async () => {
                try {
                    await firebase.auth().signOut();
                } catch (error) {
                    console.error('Error signing out:', error);
                }
            };

            const handleSendMessage = async () => {
                if (isChatting || !chatInput.trim()) return;
                
                const userMessage = { role: 'user', content: chatInput };
                const newChatHistory = [...chatHistory, userMessage];
                setChatHistory(newChatHistory);
                setChatInput('');
                setIsChatting(true);
                
                try {
                    const apiKey = "AIzaSyCEwNa6knQpuCV_eLgKLr7m-88ufWP8484";
                    const prompt = `
                    You are a professional and empathetic financial coach named Clarity. Your goal is to provide clear, actionable, and encouraging advice based on the user's financial data and their questions. Do not use markdown formatting.

                    FINANCIAL DATA SUMMARY:
                    - Total Income: ${totals.income} ${baseCurrency}
                    - Total Expenses: ${totals.expense} ${baseCurrency}
                    - Net Flow: ${totals.net} ${baseCurrency}
                    - Recent Transactions (JSON): ${JSON.stringify(transactions.slice(0, 10))}

                    CONVERSATION HISTORY:
                    ${newChatHistory.map(msg => `${msg.role}: ${msg.content}`).join('\n')}

                    Based on all the data above, provide a helpful and concise response to the user's latest question.
                    Assistant:
                    `;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] } )
                    });

                    if (!response.ok) {
                        throw new Error("The AI is currently unavailable. Please try again later.");
                    }

                    const result = await response.json();
                    const aiMessage = result.candidates[0].content.parts[0].text;
                    setChatHistory(prev => [...prev, { role: 'assistant', content: aiMessage.trim() }]);

                } catch (error) {
                    setChatHistory(prev => [...prev, { role: 'assistant', content: `Sorry, I encountered an error: ${error.message}` }]);
                } finally {
                    setIsChatting(false);
                }
            };

const handleParseText = async () => {
    if (!pastedText.trim()) {
        setMessage('Please paste text to import.');
        return;
    }
    setIsParsing(true);
    setMessage('Analyzing with AI...');

    try {
        const apiKey = "AIzaSyCEwNa6knQpuCV_eLgKLr7m-88ufWP8484"; // This is your working API key
        const prompt = `You are an expert data extraction tool. Your only job is to find and return a valid JSON array of financial transactions from the user's text. Follow these rules strictly: 1. Currency is critical. Use three-letter codes (USD, AED, etc.). 2. Date is critical. Use YYYY-MM-DD format. If a transaction has no date, exclude it. 3. Amount must be a number. 4. Your entire response must ONLY be the JSON array. Do not add any other text. USER'S TEXT TO PARSE: --- ${pastedText} ---`;
        
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] } )
        });

        if (!response.ok) {
            const errorBody = await response.text();
            throw new Error(`AI API Error: ${response.statusText}. Details: ${errorBody}`);
        }

        const result = await response.json();
        const rawJsonText = result.candidates[0].content.parts[0].text;
        
        const match = rawJsonText.match(/\[.*\]/s);
        if (!match) {
            throw new Error("The AI did not return a valid JSON array. Please check the pasted text format.");
        }
        
        const parsedTransactions = JSON.parse(match[0]);
        
        const batch = firebase.firestore().batch();
        const transactionsCollectionRef = firebase.firestore().collection(`users/${user.uid}/transactions`);

        let transactionsAdded = 0;
        parsedTransactions.forEach(transaction => {
            if (transaction.date && !isNaN(new Date(transaction.date)) && transaction.amount) {
                const newTransactionRef = transactionsCollectionRef.doc();
                batch.set(newTransactionRef, transaction);
                transactionsAdded++;
            }
        });

        if (transactionsAdded === 0) {
            throw new Error("No valid transactions with dates and amounts were found in the provided text.");
        }

        await batch.commit();
        setMessage(`Successfully imported ${transactionsAdded} transactions!`);
        setPastedText('');

    } catch (error) {
        console.error("Error during import:", error);
        setMessage(`Import Error: ${error.message}`);
    } finally {
        setIsParsing(false);
    }
};


            const showSection = (sectionId) => {
                setActiveSection(sectionId);
            };

            return (
                <div>
                    {/* Navigation */}
                    <nav className="bg-slate-900/50 backdrop-blur-sm border-b border-slate-800 sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-16">
                                <div className="flex items-center">
                                    <div className="text-2xl font-bold gradient-text">Clarity</div>
                                </div>
                                <div className="hidden md:block">
                                    <div className="ml-10 flex items-baseline space-x-4">
                                        <button onClick={() => showSection('dashboard')} className={`px-3 py-2 rounded-md text-sm font-medium ${activeSection === 'dashboard' ? 'text-blue-400' : 'text-slate-300 hover:text-white'}`}>Dashboard</button>
                                        <button onClick={() => showSection('transactions')} className={`px-3 py-2 rounded-md text-sm font-medium ${activeSection === 'transactions' ? 'text-blue-400' : 'text-slate-300 hover:text-white'}`}>Transactions</button>
                                        <button onClick={() => showSection('goals')} className={`px-3 py-2 rounded-md text-sm font-medium ${activeSection === 'goals' ? 'text-blue-400' : 'text-slate-300 hover:text-white'}`}>Goals</button>
                                        <button onClick={() => showSection('insights')} className={`px-3 py-2 rounded-md text-sm font-medium ${activeSection === 'insights' ? 'text-blue-400' : 'text-slate-300 hover:text-white'}`}>Insights</button>
                                    </div>
                                </div>
                                <div className="flex items-center space-x-4">
                                    <button className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                        Connect Bank
                                    </button>
                                    <button onClick={handleSignOut} className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                        Sign Out
                                    </button>
                                    <div className="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full"></div>
                                </div>
                            </div>
                        </div>
                    </nav>

                    {/* Main Content Container */}
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        
                        {/* Dashboard Section */}
                        {activeSection === 'dashboard' && (
                            <div>
                                {/* Welcome Section */}
                                <div className="mb-8">
                                    <h1 className="text-3xl font-bold text-white mb-2">Welcome back, {userName}! üëã</h1>
                                    <p className="text-slate-400">Here's your financial overview for this month</p>
                                </div>

                                {/* Stats Cards */}
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                                    <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6 card-hover">
                                        <div className="flex items-center justify-between">
                                            <div className="flex-1">
                                                <div className="flex items-center justify-between mb-2">
                                                    <p className="text-slate-400 text-sm font-medium">Net Balance</p>
                                                    <select 
                                                        value={baseCurrency}
                                                        onChange={(e) => {
                                                            const newCurrency = e.target.value;
                                                            setBaseCurrency(newCurrency);
                                                            localStorage.setItem('userBaseCurrency', newCurrency);
                                                        }}
                                                        className="bg-slate-800 border border-slate-700 text-white text-xs px-2 py-1 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                    >
                                                        {currencies.map(currency => (
                                                            <option key={currency.code} value={currency.code}>
                                                                {currency.symbol} {currency.code}
                                                            </option>
                                                        ))}
                                                    </select>
                                                </div>
                                                <p className="text-2xl font-bold text-white">{currencySymbol}{totals.net}</p>
                                                <p className={`text-sm mt-1 ${parseFloat(totals.net) >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                    {parseFloat(totals.net) >= 0 ? 'Positive' : 'Negative'} balance
                                                </p>
                                            </div>
                                            <div className="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center ml-4">
                                                <svg className="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                                </svg>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6 card-hover">
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <p className="text-slate-400 text-sm font-medium">Total Expenses</p>
                                                <p className="text-2xl font-bold text-white">{currencySymbol}{totals.expense}</p>
                                                <p className="text-red-400 text-sm mt-1">{transactions.filter(t => t.type !== 'Income').length} transactions</p>
                                            </div>
                                            <div className="w-12 h-12 bg-red-500/20 rounded-lg flex items-center justify-center">
                                                <svg className="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path>
                                                </svg>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6 card-hover">
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <p className="text-slate-400 text-sm font-medium">Total Income</p>
                                                <p className="text-2xl font-bold text-white">{currencySymbol}{totals.income}</p>
                                                <p className="text-green-400 text-sm mt-1">{transactions.filter(t => t.type === 'Income').length} transactions</p>
                                            </div>
                                            <div className="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center">
                                                <svg className="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                                                </svg>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6 card-hover">
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <p className="text-slate-400 text-sm font-medium">Total Transactions</p>
                                                <p className="text-2xl font-bold text-white">{transactions.length}</p>
                                                <p className="text-purple-400 text-sm mt-1">All time</p>
                                            </div>
                                            <div className="w-12 h-12 bg-purple-500/20 rounded-lg flex items-center justify-center">
                                                <svg className="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                                </svg>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Charts Section */}
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                                    {/* Spending Chart */}
                                    <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6">
                                        <h3 className="text-xl font-semibold text-white mb-4">Recent Activity</h3>
                                        <div className="h-48 flex items-center justify-center">
                                            <div className="text-center">
                                                <div className="text-4xl mb-4">üìä</div>
                                                <p className="text-slate-400">Visual charts coming soon!</p>
                                                <p className="text-sm text-slate-500 mt-2">Your data is being tracked</p>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Category Breakdown */}
                                    <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6">
                                        <h3 className="text-xl font-semibold text-white mb-4">Top Spending Categories</h3>
                                        <div className="space-y-3">
                                            {categoryBreakdown.length > 0 ? categoryBreakdown.map(([category, amount], index) => (
                                                <div key={category} className="flex items-center justify-between">
                                                    <div className="flex items-center space-x-3">
                                                        <div className={`w-3 h-3 rounded-full ${
                                                            index === 0 ? 'bg-blue-400' :
                                                            index === 1 ? 'bg-purple-400' :
                                                            index === 2 ? 'bg-pink-400' :
                                                            index === 3 ? 'bg-green-400' : 'bg-yellow-400'
                                                        }`}></div>
                                                        <span className="text-sm text-slate-300">{category}</span>
                                                    </div>
                                                    <span className="text-sm text-white">{currencySymbol}{amount.toFixed(2)}</span>
                                                </div>
                                            )) : (
                                                <div className="text-center py-8">
                                                    <p className="text-slate-400">No expense data yet</p>
                                                    <p className="text-sm text-slate-500 mt-1">Start adding transactions to see breakdown</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {/* Recent Transactions */}
                                <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6">
                                    <div className="flex justify-between items-center mb-6">
                                        <h3 className="text-xl font-semibold text-white">Recent Transactions</h3>
                                        <button onClick={() => showSection('transactions')} className="text-blue-400 hover:text-blue-300 text-sm font-medium">View All</button>
                                    </div>
                                    
                                    <div className="space-y-4">
                                        {recentTransactions.length > 0 ? recentTransactions.map((transaction) => (
                                            <div key={transaction.id} className="flex items-center justify-between py-3 border-b border-slate-800">
                                                <div className="flex items-center space-x-3">
                                                    <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${
                                                        transaction.type === 'Income' ? 'bg-green-500/20' : 'bg-red-500/20'
                                                    }`}>
                                                        <span className={`text-sm ${
                                                            transaction.type === 'Income' ? 'text-green-400' : 'text-red-400'
                                                        }`}>
                                                            {transaction.type === 'Income' ? 'üí∞' : 
                                                             transaction.subcategory === 'Groceries' ? 'üõí' :
                                                             transaction.subcategory === 'Transportation' ? 'üöó' :
                                                             transaction.subcategory === 'Entertainment' ? 'üé¨' :
                                                             transaction.subcategory === 'Utilities' ? '‚ö°' : 'üí≥'}
                                                        </span>
                                                    </div>
                                                    <div>
                                                        <p className="font-medium text-white">{transaction.description || transaction.subcategory}</p>
                                                        <p className="text-sm text-slate-400">{formatDate(transaction.date)}</p>
                                                    </div>
                                                </div>
                                                <span className={`font-medium ${
                                                    transaction.type === 'Income' ? 'text-green-400' : 'text-red-400'
                                                }`}>
                                                    {transaction.type === 'Income' ? '+' : '-'}{getSymbol(transaction.currency)}{transaction.amount}
                                                </span>
                                            </div>
                                        )) : (
                                            <div className="text-center py-8">
                                                <div className="text-4xl mb-4">üìù</div>
                                                <p className="text-slate-400">No transactions yet</p>
                                                <p className="text-sm text-slate-500 mt-1">Your transactions will appear here</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Transactions Section */}
                        {activeSection === 'transactions' && (
                            <div>
                                <div className="mb-8">
                                    <h1 className="text-3xl font-bold text-white mb-2">All Transactions</h1>
                                    <p className="text-slate-400">View and manage all your financial transactions</p>
                                </div>

                                {/* Smart Document Importer */}
                                <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6 mb-8">
                                    <div className="flex items-center space-x-3 mb-4">
                                        <div className="w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center">
                                            <svg className="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <h3 className="text-xl font-semibold text-white">Smart Document Importer</h3>
                                            <p className="text-sm text-slate-400">Paste bank statements, receipts, or transaction data to import automatically</p>
                                        </div>
                                    </div>
                                    
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-slate-300 mb-2">
                                                Paste your transaction data below:
                                            </label>
                                            <textarea 
                                                value={pastedText}
                                                onChange={(e) => setPastedText(e.target.value)}
                                                className="w-full h-32 p-4 bg-slate-800 border border-slate-700 rounded-lg text-white placeholder-slate-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                                placeholder="Paste bank statements, receipts, or any transaction text here..."
                                                disabled={isParsing}
                                            ></textarea>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <div className="flex-1">
                                                <p className="text-xs text-slate-500">
                                                    Supports: Bank statements, credit card statements, receipts, and manual transaction lists
                                                </p>
                                                {message && (
                                                    <p className={`text-sm mt-2 ${message.includes('Error') ? 'text-red-400' : message.includes('Successfully') ? 'text-green-400' : 'text-blue-400'}`}>
                                                        {message}
                                                    </p>
                                                )}
                                            </div>
                                            <button 
                                                onClick={handleParseText}
                                                disabled={isParsing || !pastedText.trim()}
                                                className={`px-6 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2 ${
                                                    isParsing || !pastedText.trim() 
                                                        ? 'bg-slate-600 text-slate-400 cursor-not-allowed' 
                                                        : 'bg-blue-600 hover:bg-blue-700 text-white'
                                                }`}
                                            >
                                                {isParsing ? (
                                                    <>
                                                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                                        <span>Processing...</span>
                                                    </>
                                                ) : (
                                                    <>
                                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                                                        </svg>
                                                        <span>Import Transactions</span>
                                                    </>
                                                )}
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6">
                                    <div className="flex justify-between items-center mb-6">
                                        <h3 className="text-xl font-semibold text-white">Transaction History ({transactions.length})</h3>
                                        <div className="flex space-x-2">
                                            <button className="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm transition-colors">Filter</button>
                                            <button className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">Export</button>
                                        </div>
                                    </div>
                                    
                                    <div className="space-y-4">
                                        {transactions.length > 0 ? transactions.map((transaction) => (
                                            <div key={transaction.id} className="flex items-center justify-between py-4 border-b border-slate-800">
                                                <div className="flex items-center space-x-4">
                                                    <div className={`w-12 h-12 rounded-lg flex items-center justify-center ${
                                                        transaction.type === 'Income' ? 'bg-green-500/20' : 'bg-red-500/20'
                                                    }`}>
                                                        <span className={`${
                                                            transaction.type === 'Income' ? 'text-green-400' : 'text-red-400'
                                                        }`}>
                                                            {transaction.type === 'Income' ? 'üí∞' : 
                                                             transaction.subcategory === 'Groceries' ? 'üõí' :
                                                             transaction.subcategory === 'Transportation' ? 'üöó' :
                                                             transaction.subcategory === 'Entertainment' ? 'üé¨' :
                                                             transaction.subcategory === 'Utilities' ? '‚ö°' : 'üí≥'}
                                                        </span>
                                                    </div>
                                                    <div>
                                                        <p className="font-medium text-white">{transaction.description || transaction.subcategory}</p>
                                                        <p className="text-sm text-slate-400">{transaction.subcategory} ‚Ä¢ {formatDate(transaction.date)}</p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <span className={`font-medium text-lg ${
                                                        transaction.type === 'Income' ? 'text-green-400' : 'text-red-400'
                                                    }`}>
                                                        {transaction.type === 'Income' ? '+' : '-'}{getSymbol(transaction.currency)}{transaction.amount}
                                                    </span>
                                                    <p className="text-xs text-slate-400">{transaction.currency}</p>
                                                </div>
                                            </div>
                                        )) : (
                                            <div className="text-center py-12">
                                                <div className="text-6xl mb-4">üìù</div>
                                                <p className="text-xl text-slate-400 mb-2">No transactions yet</p>
                                                <p className="text-slate-500">Start tracking your finances by adding your first transaction</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Goals Section */}
                        {activeSection === 'goals' && (
                            <div>
                                <div className="mb-8">
                                    <h1 className="text-3xl font-bold text-white mb-2">Financial Goals</h1>
                                    <p className="text-slate-400">Track and manage your savings goals</p>
                                </div>

                                <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6 mb-8">
                                    <div className="flex justify-between items-center mb-6">
                                        <h3 className="text-xl font-semibold text-white">Goal Planning</h3>
                                        <button className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                            Add New Goal
                                        </button>
                                    </div>
                                    
                                    <div className="text-center py-12">
                                        <div className="text-6xl mb-4">üéØ</div>
                                        <p className="text-xl text-slate-400 mb-2">Goals feature coming soon!</p>
                                        <p className="text-slate-500">Set and track your financial goals with smart recommendations</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Insights Section */}
                        {activeSection === 'insights' && (
                            <div>
                                <div className="mb-8">
                                    <h1 className="text-3xl font-bold text-white mb-2">AI Financial Coach</h1>
                                    <p className="text-slate-400">Ask questions about your finances to get personalized, AI-powered advice.</p>
                                </div>

                                <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6">
                                    <div className="flex flex-col h-96">
                                        <div ref={chatEndRef} className="flex-1 overflow-y-auto p-4 bg-slate-800 rounded-lg mb-4 space-y-4">
                                            {chatHistory.length === 0 && (
                                                <div className="text-center text-slate-400 h-full flex flex-col justify-center items-center">
                                                    <div className="text-5xl mb-4">ü§ñ</div>
                                                    <p>Ask a question to get started.</p>
                                                    <p className="text-sm text-slate-500">e.g., "How can I reduce my spending?"</p>
                                                </div>
                                            )}
                                            {chatHistory.map((message, index) => (
                                                <div key={index} className={`flex items-start gap-3 ${message.role === 'user' ? 'justify-end' : ''}`}>
                                                    {message.role === 'assistant' && (
                                                        <div className="w-8 h-8 bg-slate-700 rounded-full flex-shrink-0 flex items-center justify-center">ü§ñ</div>
                                                    )}
                                                    <div className={`p-3 rounded-lg max-w-lg ${message.role === 'user' ? 'bg-blue-600 text-white' : 'bg-slate-700'}`}>
                                                        <p className="whitespace-pre-wrap">{message.content}</p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <input 
                                                type="text" 
                                                value={chatInput} 
                                                onChange={(e) => setChatInput(e.target.value)} 
                                                onKeyDown={(e) => { if (e.key === 'Enter' && !isChatting) handleSendMessage(); }} 
                                                placeholder="Ask a financial question..." 
                                                className="flex-1 p-3 rounded-lg bg-slate-800 border border-slate-700 text-gray-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                                disabled={isChatting}
                                            />
                                            <button 
                                                onClick={handleSendMessage} 
                                                disabled={isChatting || !chatInput.trim()} 
                                                className={`p-3 rounded-lg font-semibold transition-colors shadow-lg flex items-center justify-center w-24 ${isChatting || !chatInput.trim() ? 'bg-slate-600 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}`}
                                            >
                                                {isChatting ? <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div> : "Ask"}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- App Gatekeeper ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [auth, setAuth] = useState(null);
            const [db, setDb] = useState(null);
            const [isInitializing, setIsInitializing] = useState(true);
            const [error, setError] = useState('');

            useEffect(() => {
                const firebaseConfig = {
                    apiKey: "AIzaSyCEwNa6knQpuCV_eLgKLr7m-88ufWP8484",
                    authDomain: "financial-wellness-dashboard.firebaseapp.com",
                    projectId: "financial-wellness-dashboard",
                    storageBucket: "financial-wellness-dashboard.appspot.com",
                    messagingSenderId: "599378817258",
                    appId: "1:599378817258:web:95841307d6960986f36793"
                };

                try {
                    firebase.initializeApp(firebaseConfig);
                    const authInstance = firebase.auth();
                    const dbInstance = firebase.firestore();
                    setAuth(authInstance);
                    setDb(dbInstance);
                    
                    const unsubscribe = authInstance.onAuthStateChanged((currentUser) => {
                        setUser(currentUser);
                        setIsInitializing(false);
                    });
                    return () => unsubscribe();
                } catch (error) {
                    console.error("Error initializing Firebase:", error);
                    setError("Failed to initialize app");
                    setIsInitializing(false);
                }
            }, []);

            if (isInitializing) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-slate-950">
                        <div className="text-center">
                            <div className="text-4xl font-bold gradient-text mb-4">Clarity</div>
                            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
                            <p className="text-slate-400 mt-4">Loading your dashboard...</p>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-slate-950">
                        <div className="text-center">
                            <div className="text-red-400 text-xl mb-4">‚ö†Ô∏è Error</div>
                            <p className="text-slate-400">{error}</p>
                        </div>
                    </div>
                );
            }

            return user ? <FinancialDashboard user={user} db={db} auth={auth} /> : <LoginPage auth={auth} setError={setError} />;
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>

<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97d0e8e63556c71e',t:'MTc1NzUyODExNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
