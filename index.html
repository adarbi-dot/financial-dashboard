<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Clarity - Financial Wellness Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <!-- React + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap">
  <style>
    body { font-family: 'DM Sans', sans-serif; }
    .gradient-text {
      background: linear-gradient(to right, #38bdf8, #a78bfa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .card-hover { transition: transform .2s ease, box-shadow .2s ease; }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,.2); }
  </style>
</head>
<body class="bg-slate-950 text-slate-300">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    // Helper data
    const exchangeRates = { USD: 1, AED: 3.67, EUR: 1.08, GBP: 1.25 };
    const categories = {
      'Personal Expense': ['Groceries', 'Rent', 'Utilities', 'Entertainment', 'Transportation', 'Subscriptions', 'Other Personal'],
      'Business Expense': ['Software', 'Freelance Tools', 'Co-working Space', 'Marketing', 'Education', 'Other Business'],
      'Income': ['Client Work', 'Bonus', 'Tips', 'Salary', 'Other Income']
    };
    const currencies = [
      { code: 'USD', symbol: '$' },
      { code: 'AED', symbol: 'د.إ' },
      { code: 'EUR', symbol: '€' },
      { code: 'GBP', symbol: '£' }
    ];
    const getSymbol = (code) => currencies.find(c => c.code === code)?.symbol || '';
    const formatDate = (dateString) => new Date(dateString).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

    // Login Component
    const LoginPage = ({ setError }) => {
      const [isLogin, setIsLogin] = useState(true);
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');

      const handleAuthAction = async (e) => {
        e.preventDefault();
        setError('');
        try {
          if (isLogin) await firebase.auth().signInWithEmailAndPassword(email, password);
          else await firebase.auth().createUserWithEmailAndPassword(email, password);
        } catch (err) { setError(err.message); }
      };

      return (
        <div className="flex items-center justify-center min-h-screen bg-slate-950">
          <div className="w-full max-w-md p-8 space-y-6 bg-slate-900 rounded-2xl shadow-2xl">
            <div className="text-center">
              <h1 className="text-4xl font-extrabold gradient-text">Clarity</h1>
              <p className="text-slate-400 mt-2">{isLogin ? 'Welcome back, log in to continue' : 'Create an account to get started'}</p>
            </div>
            <form onSubmit={handleAuthAction} className="space-y-6">
              <div>
                <label className="block text-sm font-medium mb-1 text-slate-400">Email Address</label>
                <input type="email" value={email} onChange={(e)=>setEmail(e.target.value)} required
                       className="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 focus:ring-2 focus:ring-blue-500 text-white"
                       placeholder="you@example.com"/>
              </div>
              <div>
                <label className="block text-sm font-medium mb-1 text-slate-400">Password</label>
                <input type="password" value={password} onChange={(e)=>setPassword(e.target.value)} required
                       className="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 focus:ring-2 focus:ring-blue-500 text-white"
                       placeholder="••••••••"/>
              </div>
              <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                {isLogin ? 'Login' : 'Sign Up'}
              </button>
            </form>
            <p className="text-center text-sm text-slate-400">
              {isLogin ? "Don't have an account? " : "Already have an account? "}
              <button onClick={() => { setIsLogin(!isLogin); setError(''); }} className="font-medium text-blue-400 hover:underline">
                {isLogin ? 'Sign Up' : 'Login'}
              </button>
            </p>
          </div>
        </div>
      );
    };

    // Main Dashboard Component
    const FinancialDashboard = ({ user }) => {
      const [transactions, setTransactions] = useState([]);
      const [baseCurrency, setBaseCurrency] = useState(localStorage.getItem('userBaseCurrency') || 'USD');
      const [activeSection, setActiveSection] = useState('dashboard');

      // Importer states
      const [pastedText, setPastedText] = useState('');
      const [isParsing, setIsParsing] = useState(false);
      const [message, setMessage] = useState('');

      // Insights states
      const [insights, setInsights] = useState([]);
      const [isGeneratingInsights, setIsGeneratingInsights] = useState(false);

      // Chat states
      const [chatMessages, setChatMessages] = useState([]);
      const [chatInput, setChatInput] = useState('');
      const [isChatLoading, setIsChatLoading] = useState(false);

      // Goals states
      const [goals, setGoals] = useState([]);
      const [futureExpenses, setFutureExpenses] = useState([]);
      const [showAddGoal, setShowAddGoal] = useState(false);
      const [showAddExpense, setShowAddExpense] = useState(false);
      const [newGoal, setNewGoal] = useState({ name: '', target: '', deadline: '', saved: 0 });
      const [newExpense, setNewExpense] = useState({ name: '', amount: '', date: '', category: 'School Fees' });

      // Monthly states
      const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
      const [monthlyInsights, setMonthlyInsights] = useState('');
      const [isAnalyzingMonth, setIsAnalyzingMonth] = useState(false);

      // Load transactions from Firebase
      useEffect(() => {
        if (!user) return;
        const transactionsRef = firebase.firestore().collection(`users/${user.uid}/transactions`);
        const unsubscribe = transactionsRef.onSnapshot((snapshot) => {
          const fetched = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          fetched.sort((a, b) => new Date(b.date) - new Date(a.date));
          setTransactions(fetched);
        });
        return () => unsubscribe();
      }, [user]);

      // Load goals and future expenses
      useEffect(() => {
        if (!user) return;
        const goalsRef = firebase.firestore().collection(`users/${user.uid}/goals`);
        const expensesRef = firebase.firestore().collection(`users/${user.uid}/futureExpenses`);
        
        const unsubGoals = goalsRef.onSnapshot(snapshot => {
          setGoals(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });
        
        const unsubExpenses = expensesRef.onSnapshot(snapshot => {
          setFutureExpenses(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });
        
        return () => { unsubGoals(); unsubExpenses(); };
      }, [user]);

      // Calculate totals
      const totals = useMemo(() => {
        let totalIncome = 0, totalExpense = 0;
        transactions.forEach(t => {
          const rate = exchangeRates[t.currency] || 1;
          const baseRate = exchangeRates[baseCurrency] || 1;
          const convertedAmount = t.amount * (rate / baseRate);
          if (t.type === 'Income') totalIncome += convertedAmount;
          else totalExpense += convertedAmount;
        });
        return {
          income: totalIncome.toFixed(2),
          expense: totalExpense.toFixed(2),
          net: (totalIncome - totalExpense).toFixed(2)
        };
      }, [transactions, baseCurrency]);

      // Monthly transactions grouping
      const getMonthlyTransactions = useMemo(() => {
        const grouped = {};
        transactions.forEach(t => {
          const month = t.date.slice(0, 7);
          if (!grouped[month]) grouped[month] = [];
          grouped[month].push(t);
        });
        return grouped;
      }, [transactions]);

      const getMonthlyTotals = (monthTransactions) => {
        let income = 0, expense = 0;
        monthTransactions.forEach(t => {
          const rate = exchangeRates[t.currency] || 1;
          const baseRate = exchangeRates[baseCurrency] || 1;
          const convertedAmount = t.amount * (rate / baseRate);
          if (t.type === 'Income') income += convertedAmount;
          else expense += convertedAmount;
        });
        return { income: income.toFixed(2), expense: expense.toFixed(2), net: (income - expense).toFixed(2) };
      };

      // Calculate spending patterns
      const spendingPatterns = useMemo(() => {
        if (transactions.length === 0) {
          return {
            highestSpendingDay: 'N/A',
            mostFrequentCategory: 'N/A',
            averageTransaction: '0.00',
            monthlyTrend: 'N/A'
          };
        }

        const daySpending = {};
        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        
        transactions.forEach(t => {
          if (t.type !== 'Income') {
            const day = new Date(t.date).getDay();
            const dayName = dayNames[day];
            const rate = exchangeRates[t.currency] || 1;
            const baseRate = exchangeRates[baseCurrency] || 1;
            const convertedAmount = t.amount * (rate / baseRate);
            daySpending[dayName] = (daySpending[dayName] || 0) + convertedAmount;
          }
        });
        
        const highestSpendingDay = Object.keys(daySpending).length > 0 
          ? Object.entries(daySpending).reduce((a, b) => a[1] > b[1] ? a : b)[0]
          : 'N/A';

        const categoryCount = {};
        transactions.forEach(t => {
          if (t.type !== 'Income' && t.subcategory) {
            categoryCount[t.subcategory] = (categoryCount[t.subcategory] || 0) + 1;
          }
        });
        
        const mostFrequentCategory = Object.keys(categoryCount).length > 0
          ? Object.entries(categoryCount).reduce((a, b) => a[1] > b[1] ? a : b)[0]
          : 'N/A';

        const expenseTransactions = transactions.filter(t => t.type !== 'Income');
        const totalExpenseAmount = expenseTransactions.reduce((sum, t) => {
          const rate = exchangeRates[t.currency] || 1;
          const baseRate = exchangeRates[baseCurrency] || 1;
          return sum + (t.amount * (rate / baseRate));
        }, 0);
        
        const averageTransaction = expenseTransactions.length > 0 
          ? (totalExpenseAmount / expenseTransactions.length).toFixed(2)
          : '0.00';

        return {
          highestSpendingDay,
          mostFrequentCategory,
          averageTransaction,
          monthlyTrend: '+8.2% ↗'
        };
      }, [transactions, baseCurrency]);

      const recentTransactions = transactions.slice(0, 5);
      const userName = user.email.split('@')[0];
      const currencySymbol = getSymbol(baseCurrency);

      const categoryBreakdown = useMemo(() => {
        const breakdown = {};
        transactions.forEach(t => {
          if (t.type !== 'Income') {
            const rate = exchangeRates[t.currency] || 1;
            const baseRate = exchangeRates[baseCurrency] || 1;
            const convertedAmount = t.amount * (rate / baseRate);
            breakdown[t.subcategory] = (breakdown[t.subcategory] || 0) + convertedAmount;
          }
        });
        return Object.entries(breakdown).sort((a,b)=>b[1]-a[1]).slice(0,5);
      }, [transactions, baseCurrency]);

      const handleSignOut = async () => {
        try { await firebase.auth().signOut(); } catch (e) { console.error(e); }
      };

      // Delete transaction function
      const handleDeleteTransaction = async (transactionId) => {
        if (!confirm('Are you sure you want to delete this transaction?')) return;
        try {
          await firebase.firestore().collection(`users/${user.uid}/transactions`).doc(transactionId).delete();
        } catch (error) {
          console.error('Error deleting transaction:', error);
          alert('Failed to delete transaction. Please try again.');
        }
      };

      // AI-powered transaction parser
      const handleParseText = async () => {
        if (!pastedText.trim()) { setMessage('Please paste text to import.'); return; }
        setIsParsing(true);
        setMessage('Analyzing with AI...');
        try {
          const apiKey = "AIzaSyCEwNa6knQpuCV_eLgKLr7m-88ufWP8484";
          const prompt = `You are an expert data extraction tool. Your only job is to find and return a valid JSON array of financial transactions from the user's text. Follow these rules strictly:
1.  **Date is CRITICAL.** You MUST convert any date format (e.g., DD/MM/YYYY, MM-DD-YY, Month D, YYYY) into the strict YYYY-MM-DD format. If a transaction has no date, exclude it.
2.  **Amount is CRITICAL.** The 'amount' field must be a number only. You MUST remove any commas, currency symbols, or other non-numeric characters. For example, "$250,000.00" must become 250000.
3.  **Currency is CRITICAL.** Use three-letter codes (USD, AED, etc.).
4.  **Type is CRITICAL.** You must determine if the transaction is 'Income' or an 'Expense' type.
5.  **Your entire response must ONLY be the JSON array.** Do not add any other text.

USER'S TEXT TO PARSE:
---
${pastedText}
---
`;
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
          });
          if (!response.ok) {
            const errorBody = await response.text();
            throw new Error(`AI API Error: ${response.statusText}. Details: ${errorBody}`);
          }
          const result = await response.json();
          const rawJsonText = result.candidates[0].content.parts[0].text;
          const match = rawJsonText.match(/\[.*\]/s);
          if (!match) throw new Error("The AI did not return a valid JSON array. Please check the pasted text format.");

          const parsedTransactions = JSON.parse(match[0]);

          const batch = firebase.firestore().batch();
          const transactionsCollectionRef = firebase.firestore().collection(`users/${user.uid}/transactions`);

          let transactionsAdded = 0;
          parsedTransactions.forEach(transaction => {
            if (transaction.date && !isNaN(new Date(transaction.date)) && transaction.amount) {
              const newRef = transactionsCollectionRef.doc();
              batch.set(newRef, transaction);
              transactionsAdded++;
            }
          });

          if (transactionsAdded === 0) throw new Error("No valid transactions with dates and amounts were found in the provided text.");

          await batch.commit();
          setMessage(`Successfully imported ${transactionsAdded} transactions!`);
          setPastedText('');
        } catch (error) {
          console.error("Error during import:", error);
          setMessage(`Import Error: ${error.message}`);
        } finally {
          setIsParsing(false);
        }
      };

      // AI insights generation
      const handleGenerateInsights = async () => {
        if (isGeneratingInsights) return;
        setIsGeneratingInsights(true);
        setInsights([]);

        try {
          const apiKey = "AIzaSyCEwNa6knQpuCV_eLgKLr7m-88ufWP8484";
          const prompt = `
        You are Clarity, an expert financial analyst. Analyze the user's financial data and provide exactly three brief, actionable recommendations.
        
        **STRICT RULES:**
        1. Analyze the provided financial data summary carefully
        2. Generate exactly three recommendations
        3. Each recommendation must have: "title", "recommendation", and "type" ('positive', 'negative', or 'neutral')
        4. Keep recommendations under 100 characters each
        5. Your ENTIRE response must be ONLY a valid JSON array like this:
            [
              {"type": "negative", "title": "High Dining Costs", "recommendation": "You spent 15% more on dining. Try meal planning to save $200/month."},
              {"type": "positive", "title": "Great Savings Rate", "recommendation": "Excellent! You're saving 20% of income. Keep up the momentum."},
              {"type": "neutral", "title": "Diversify Investments", "recommendation": "Consider investing your surplus in index funds for long-term growth."}
            ]
        6. NO other text, explanations, or formatting - ONLY the JSON array

        **USER'S FINANCIAL DATA:**
        ---
        Total Income: ${totals.income} ${baseCurrency}
        Total Expenses: ${totals.expense} ${baseCurrency}
        Net Flow: ${totals.net} ${baseCurrency}
        Transaction Count: ${transactions.length}
        Base Currency: ${baseCurrency}
        Recent Transactions: ${JSON.stringify(transactions.slice(0, 10))}
        ---
        `;

          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
          });

          if (!response.ok) {
            throw new Error("AI analysis service unavailable. Please try again later.");
          }

          const result = await response.json();
          const rawJsonText = result.candidates[0].content.parts[0].text;
          const match = rawJsonText.match(/\[.*\]/s);
          if (!match) {
            throw new Error("Invalid AI response format. Please try again.");
          }
          const parsedInsights = JSON.parse(match[0]);
          
          if (!Array.isArray(parsedInsights) || parsedInsights.length !== 3) {
            throw new Error("AI returned incorrect number of insights.");
          }
          
          setInsights(parsedInsights);
        } catch (error) {
          console.error("Error generating insights:", error);
          setInsights([{
            type: 'negative',
            title: 'Analysis Error',
            recommendation: `Unable to generate insights: ${error.message}. Please check your data and try again.`
          }]);
        } finally {
          setIsGeneratingInsights(false);
        }
      };

      // Chat with AI
      const handleSendChatMessage = async () => {
        if (!chatInput.trim() || isChatLoading) return;
        const userMessage = chatInput.trim();
        setChatInput('');
        setChatMessages(prev => [...prev, { type: 'user', message: userMessage }]);
        setIsChatLoading(true);
        
        try {
          const apiKey = "AIzaSyCEwNa6knQpuCV_eLgKLr7m-88ufWP8484";
          const prompt = `You are Clarity, a financial advisor AI. Answer this question about the user's finances: "${userMessage}". User's data: Income: ${totals.income} ${baseCurrency}, Expenses: ${totals.expense} ${baseCurrency}, Recent transactions: ${JSON.stringify(transactions.slice(0,10))}. Keep response under 100 words.`;
          
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
          });
          
          const result = await response.json();
          const aiResponse = result.candidates[0].content.parts[0].text;
          setChatMessages(prev => [...prev, { type: 'ai', message: aiResponse }]);
        } catch (error) {
          setChatMessages(prev => [...prev, { type: 'ai', message: 'Sorry, I encountered an error. Please try again.' }]);
        } finally {
          setIsChatLoading(false);
        }
      };

      // Goals functions
      const handleAddGoal = async () => {
        if (!newGoal.name || !newGoal.target || !newGoal.deadline) return;
        try {
          const goalRef = firebase.firestore().collection(`users/${user.uid}/goals`);
          await goalRef.add({ ...newGoal, target: parseFloat(newGoal.target), createdAt: new Date() });
          setNewGoal({ name: '', target: '', deadline: '', saved: 0 });
          setShowAddGoal(false);
        } catch (error) {
          console.error('Error adding goal:', error);
        }
      };

      const handleAddExpense = async () => {
        if (!newExpense.name || !newExpense.amount || !newExpense.date) return;
        try {
          const expenseRef = firebase.firestore().collection(`users/${user.uid}/futureExpenses`);
          await expenseRef.add({ ...newExpense, amount: parseFloat(newExpense.amount), createdAt: new Date() });
          setNewExpense({ name: '', amount: '', date: '', category: 'School Fees' });
          setShowAddExpense(false);
        } catch (error) {
          console.error('Error adding expense:', error);
        }
      };

      // Monthly analysis
      const analyzeMonth = async (month) => {
        setIsAnalyzingMonth(true);
        const monthTransactions = getMonthlyTransactions[month] || [];
        const totals = getMonthlyTotals(monthTransactions);
        
        try {
          const apiKey = "AIzaSyCEwNa6knQpuCV_eLgKLr7m-88ufWP8484";
          const prompt = `Analyze this month's spending for ${month}. Income: ${totals.income} ${baseCurrency}, Expenses: ${totals.expense} ${baseCurrency}, Net: ${totals.net} ${baseCurrency}. Transactions: ${JSON.stringify(monthTransactions.slice(0,20))}. Provide a brief 2-sentence analysis of spending patterns and one actionable tip.`;
          
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
          });
          
          const result = await response.json();
          setMonthlyInsights(result.candidates[0].content.parts[0].text);
        } catch (error) {
          setMonthlyInsights('Unable to analyze this month. Please try again.');
        } finally {
          setIsAnalyzingMonth(false);
        }
      };

      const showSection = (id) => setActiveSection(id);

      return (
        <div>
          {/* Navigation */}
          <nav className="bg-slate-900/50 backdrop-blur-sm border-b border-slate-800 sticky top-0 z-50">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
              <div className="flex justify-between items-center h-16">
                <div className="flex items-center">
                  <div className="text-2xl font-bold gradient-text">Clarity</div>
                </div>
                <div className="hidden md:block">
                  <div className="ml-10 flex items-baseline space-x-4">
                    <button onClick={() => showSection('dashboard')}
                            className={`px-3 py-2 rounded-md text-sm font-medium ${activeSection === 'dashboard' ? 'text-blue-400' : 'text-slate-300 hover:text-white'}`}>
                      Dashboard
                    </button>
                    <button onClick={() => showSection('transactions')}
                            className={`px-3 py-2 rounded-md text-sm font-medium ${activeSection === 'transactions' ? 'text-blue-400' : 'text-slate-300 hover:text-white'}`}>
                      Transactions
                    </button>
                    <button onClick={() => showSection('goals')}
                            className={`px-3 py-2 rounded-md text-sm font-medium ${activeSection === 'goals' ? 'text-blue-400' : 'text-slate-300 hover:text-white'}`}>
                      Goals
                    </button>
                    <button onClick={() => showSection('insights')}
                            className={`px-3 py-2 rounded-md text-sm font-medium ${activeSection === 'insights' ? 'text-blue-400' : 'text-slate-300 hover:text-white'}`}>
                      Insights
                    </button>
                  </div>
                </div>
                <div className="flex items-center space-x-4">
                  <button className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    Connect Bank
                  </button>
                  <button onClick={handleSignOut}
                          className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    Sign Out
                  </button>
                  <div className="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full"></div>
                </div>
              </div>
            </div>
          </nav>

          {/* Main Content */}
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            {/* Dashboard Section */}
            {activeSection === 'dashboard' && (
              <div>
                <div className="mb-8">
                  <h1 className="text-3xl font-bold text-white mb-2">Welcome back, {userName}! 👋</h1>
                  <p className="text-slate-400">Here's your financial overview for this month</p>
                </div>

                {/* Summary Cards */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                  <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6 card-hover">
                    <div className="flex items-center justify-between">
                      <div className="flex-1">
                        <div className="flex items-center justify-between mb-2">
                          <p className="text-slate-400 text-sm font-medium">Net Balance</p>
                          <select
                            value={baseCurrency}
                            onChange={(e) => { setBaseCurrency(e.target.value); localStorage.setItem('userBaseCurrency', e.target.value); }}
                            className="bg-slate-800 border border-slate-700 text-white text-xs px-2 py-1 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          >
                            {currencies.map(c => <option key={c.code} value={c.code}>{c.symbol} {c.code}</option>)}
                          </select>
                        </div>
                        <p className="text-2xl font-bold text-white">{currencySymbol}{totals.net}</p>
                        <p className={`text-sm mt-1 ${parseFloat(totals.net) >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                          {parseFloat(totals.net) >= 0 ? 'Positive' : 'Negative'} balance
                        </p>
                      </div>
                      <div className="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center ml-4">
                        <svg className="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                      </div>
                    </div>
                  </div>

                  <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6 card-hover">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-slate-400 text-sm font-medium">Total Expenses</p>
                        <p className="text-2xl font-bold text-white">{currencySymbol}{totals.expense}</p>
                        <p className="text-red-400 text-sm mt-1">{transactions.filter(t => t.type !== 'Income').length} transactions</p>
                      </div>
                      <div className="w-12 h-12 bg-red-500/20 rounded-lg flex items-center justify-center">
                        <svg className="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path>
                        </svg>
                      </div>
                    </div>
                  </div>

                  <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6 card-hover">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-slate-400 text-sm font-medium">Total Income</p>
                        <p className="text-2xl font-bold text-white">{currencySymbol}{totals.income}</p>
                        <p className="text-green-400 text-sm mt-1">{transactions.filter(t => t.type === 'Income').length} transactions</p>
                      </div>
                      <div className="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center">
                        <svg className="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                        </svg>
                      </div>
                    </div>
                  </div>

                  <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6 card-hover">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-slate-400 text-sm font-medium">Total Transactions</p>
                        <p className="text-2xl font-bold text-white">{transactions.length}</p>
                        <p className="text-purple-400 text-sm mt-1">All time</p>
                      </div>
                      <div className="w-12 h-12 bg-purple-500/20 rounded-lg flex items-center justify-center">
                        <svg className="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Charts and Categories */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                  <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6">
                    <h3 className="text-xl font-semibold text-white mb-4">Recent Activity</h3>
                    <div className="h-48 flex items-center justify-center">
                      <div className="text-center">
                        <div className="text-4xl mb-4">📊</div>
                        <p className="text-slate-400">Visual charts coming soon!</p>
                        <p className="text-sm text-slate-500 mt-2">Your data is being tracked</p>
                      </div>
                    </div>
                  </div>
                  <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6">
                    <h3 className="text-xl font-semibold text-white mb-4">Top Spending Categories</h3>
                    <div className="space-y-3">
                      {categoryBreakdown.length > 0 ? categoryBreakdown.map(([category, amount], index) => (
                        <div key={category} className="flex items-center justify-between">
                          <div className="flex items-center space-x-3">
                            <div className={`w-3 h-3 rounded-full ${
                              index === 0 ? 'bg-blue-400' :
                              index === 1 ? 'bg-purple-400' :
                              index === 2 ? 'bg-pink-400' :
                              index === 3 ? 'bg-green-400' : 'bg-yellow-400'
                            }`}></div>
                            <span className="text-sm text-slate-300">{category}</span>
                          </div>
                          <span className="text-sm text-white">{currencySymbol}{amount.toFixed(2)}</span>
                        </div>
                      )) : (
                        <div className="text-center py-8">
                          <p className="text-slate-400">No expense data yet</p>
                          <p className="text-sm text-slate-500 mt-1">Start adding transactions to see breakdown</p>
                        </div>
                      )}
                    </div>
                  </div>
                </div>

                {/* Recent Transactions */}
                <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6">
                  <div className="flex justify-between items-center mb-6">
                    <h3 className="text-xl font-semibold text-white">Recent Transactions</h3>
                    <button onClick={() => showSection('transactions')}
                            className="text-blue-400 hover:text-blue-300 text-sm font-medium">View All</button>
                  </div>
                  <div className="space-y-4">
                    {recentTransactions.length > 0 ? recentTransactions.map((transaction) => (
                      <div key={transaction.id} className="flex items-center justify-between py-3 border-b border-slate-800">
                        <div className="flex items-center space-x-3">
                          <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${
                            transaction.type === 'Income' ? 'bg-green-500/20' : 'bg-red-500/20'
                          }`}>
                            <span className={`text-sm ${transaction.type === 'Income' ? 'text-green-400' : 'text-red-400'}`}>
                              {transaction.type === 'Income' ? '💰' :
                               transaction.subcategory === 'Groceries' ? '🛒' :
                               transaction.subcategory === 'Transportation' ? '🚗' :
                               transaction.subcategory === 'Entertainment' ? '🎬' :
                               transaction.subcategory === 'Utilities' ? '⚡' : '💳'}
                            </span>
                          </div>
                          <div>
                            <p className="font-medium text-white">{transaction.description || transaction.subcategory}</p>
                            <p className="text-sm text-slate-400">{formatDate(transaction.date)}</p>
                          </div>
                        </div>
                        <span className={`font-medium ${transaction.type === 'Income' ? 'text-green-400' : 'text-red-400'}`}>
                          {transaction.type === 'Income' ? '+' : '-'}{getSymbol(transaction.currency)}{transaction.amount}
                        </span>
                      </div>
                    )) : (
                      <div className="text-center py-8">
                        <div className="text-4xl mb-4">📝</div>
                        <p className="text-slate-400">No transactions yet</p>
                        <p className="text-sm text-slate-500 mt-1">Your transactions will appear here</p>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}

            {/* Transactions Section with Monthly Filtering */}
            {activeSection === 'transactions' && (
              <div>
                <div className="mb-8">
                  <h1 className="text-3xl font-bold text-white mb-2">All Transactions</h1>
                  <p className="text-slate-400">View and manage all your financial transactions</p>
                </div>

                {/* Smart Importer */}
                <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6 mb-8">
                  <div className="flex items-center space-x-3 mb-4">
                    <div className="w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center">
                      <svg className="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                      </svg>
                    </div>
                    <div>
                      <h3 className="text-xl font-semibold text-white">Smart Document Importer</h3>
                      <p className="text-sm text-slate-400">Paste bank statements, receipts, or transaction data to import automatically</p>
                    </div>
                  </div>

                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-slate-300 mb-2">Paste your transaction data below:</label>
                      <textarea value={pastedText} onChange={(e)=>setPastedText(e.target.value)}
                                className="w-full h-32 p-4 bg-slate-800 border border-slate-700 rounded-lg text-white placeholder-slate-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                placeholder="Paste bank statements, receipts, or any transaction text here..." disabled={isParsing}></textarea>
                    </div>
                    <div className="flex justify-between items-center">
                      <div className="flex-1">
                        <p className="text-xs text-slate-500">Supports: Bank statements, credit card statements, receipts, and manual transaction lists</p>
                        {message && (
                          <p className={`text-sm mt-2 ${message.includes('Error') ? 'text-red-400' : message.includes('Successfully') ? 'text-green-400' : 'text-blue-400'}`}>
                            {message}
                          </p>
                        )}
                      </div>
                      <button onClick={handleParseText} disabled={isParsing || !pastedText.trim()}
                              className={`px-6 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2 ${
                                isParsing || !pastedText.trim() ? 'bg-slate-600 text-slate-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 text-white'
                              }`}>
                        {isParsing ? (
                          <>
                            <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                            <span>Processing...</span>
                          </>
                        ) : (
                          <>
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                            </svg>
                            <span>Import Transactions</span>
                          </>
                        )}
                      </button>
                    </div>
                  </div>
                </div>

                {/* Enhanced Transaction History with Monthly View */}
                <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6">
                  <div className="flex justify-between items-center mb-6">
                    <h3 className="text-xl font-semibold text-white">Transaction History ({transactions.length})</h3>
                    <div className="flex space-x-2">
                      <select value={selectedMonth} onChange={(e) => setSelectedMonth(e.target.value)}
                              className="bg-slate-700 border border-slate-600 text-white px-3 py-2 rounded-lg text-sm">
                        <option value="">All Months</option>
                        {Object.keys(getMonthlyTransactions).sort().reverse().map(month => (
                          <option key={month} value={month}>
                            {new Date(month + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'long' })}
                          </option>
                        ))}
                      </select>
                      <button className="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm transition-colors">Filter</button>
                      <button className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">Export</button>
                    </div>
                  </div>

                  {/* Monthly Summary */}
                  {selectedMonth && getMonthlyTransactions[selectedMonth] && (
                    <div className="mb-6 p-4 bg-slate-800 rounded-lg">
                      <div className="flex justify-between items-center mb-4">
                        <h4 className="text-lg font-semibold text-white">
                          {new Date(selectedMonth + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'long' })} Summary
                        </h4>
                        <button onClick={() => analyzeMonth(selectedMonth)} disabled={isAnalyzingMonth}
                                className="bg-purple-600 hover:bg-purple-700 disabled:bg-slate-600 text-white px-3 py-1 rounded text-sm">
                          {isAnalyzingMonth ? 'Analyzing...' : 'AI Analysis'}
                        </button>
                      </div>
                      
                      {(() => {
                        const monthTotals = getMonthlyTotals(getMonthlyTransactions[selectedMonth]);
                        return (
                          <div className="grid grid-cols-3 gap-4 mb-4">
                            <div className="text-center">
                              <p className="text-slate-400 text-sm">Income</p>
                              <p className="text-green-400 font-semibold">{currencySymbol}{monthTotals.income}</p>
                            </div>
                            <div className="text-center">
                              <p className="text-slate-400 text-sm">Expenses</p>
                              <p className="text-red-400 font-semibold">{currencySymbol}{monthTotals.expense}</p>
                            </div>
                            <div className="text-center">
                              <p className="text-slate-400 text-sm">Net</p>
                              <p className={`font-semibold ${parseFloat(monthTotals.net) >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                {currencySymbol}{monthTotals.net}
                              </p>
                            </div>
                          </div>
                        );
                      })()}
                      
                      {monthlyInsights && (
                        <div className="p-3 bg-slate-700 rounded-lg">
                          <p className="text-slate-300 text-sm">{monthlyInsights}</p>
                        </div>
                      )}
                    </div>
                  )}

                  <div className="space-y-4">
                    {(() => {
                      const displayTransactions = selectedMonth ? 
                        (getMonthlyTransactions[selectedMonth] || []) : 
                        transactions;
                      
                      return displayTransactions.length > 0 ? displayTransactions.map((transaction) => (
                        <div key={transaction.id} className="flex items-center justify-between py-4 border-b border-slate-800">
                          <div className="flex items-center space-x-4">
                            <div className={`w-12 h-12 rounded-lg flex items-center justify-center ${transaction.type === 'Income' ? 'bg-green-500/20' : 'bg-red-500/20'}`}>
                              <span className={`${transaction.type === 'Income' ? 'text-green-400' : 'text-red-400'}`}>
                                {transaction.type === 'Income' ? '💰' :
                                 transaction.subcategory === 'Groceries' ? '🛒' :
                                 transaction.subcategory === 'Transportation' ? '🚗' :
                                 transaction.subcategory === 'Entertainment' ? '🎬' :
                                 transaction.subcategory === 'Utilities' ? '⚡' : '💳'}
                              </span>
                            </div>
                            <div>
                              <p className="font-medium text-white">{transaction.description || transaction.subcategory}</p>
                              <p className="text-sm text-slate-400">{transaction.subcategory} • {formatDate(transaction.date)}</p>
                            </div>
                          </div>
                          <div className="flex items-center space-x-4">
                            <div className="text-right">
                              <span className={`font-medium text-lg ${transaction.type === 'Income' ? 'text-green-400' : 'text-red-400'}`}>
                                {transaction.type === 'Income' ? '+' : '-'}{getSymbol(transaction.currency)}{transaction.amount}
                              </span>
                              <p className="text-xs text-slate-400">{transaction.currency}</p>
                            </div>
                            <div className="flex space-x-2">
                              <button onClick={() => alert('Edit feature coming soon!')} className="p-2 text-slate-400 hover:text-blue-400 transition-colors">
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path>
                                </svg>
                              </button>
                              <button onClick={() => handleDeleteTransaction(transaction.id)} className="p-2 text-slate-400 hover:text-red-400 transition-colors">
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                              </button>
                            </div>
                          </div>
                        </div>
                      )) : (
                        <div className="text-center py-12">
                          <div className="text-6xl mb-4">📝</div>
                          <p className="text-xl text-slate-400 mb-2">No transactions for this period</p>
                          <p className="text-slate-500">Try selecting a different month or add new transactions</p>
                        </div>
                      );
                    })()}
                  </div>
                </div>
              </div>
            )}

            {/* Enhanced Goals Section */}
            {activeSection === 'goals' && (
              <div>
                <div className="mb-8">
                  <h1 className="text-3xl font-bold text-white mb-2">Financial Goals</h1>
                  <p className="text-slate-400">Track savings goals and plan future expenses</p>
                </div>
                
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                  {/* Savings Goals */}
                  <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6">
                    <div className="flex justify-between items-center mb-6">
                      <h3 className="text-xl font-semibold text-white">🎯 Savings Goals</h3>
                      <button onClick={() => setShowAddGoal(true)}
                              className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        Add Goal
                      </button>
                    </div>
                    
                    {showAddGoal && (
                      <div className="mb-6 p-4 bg-slate-800 rounded-lg">
                        <h4 className="text-white font-medium mb-3">Add New Goal</h4>
                        <div className="space-y-3">
                          <input value={newGoal.name} onChange={(e)=>setNewGoal({...newGoal, name: e.target.value})}
                                 placeholder="Goal name (e.g., Emergency Fund)" className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-white"/>
                          <input value={newGoal.target} onChange={(e)=>setNewGoal({...newGoal, target: e.target.value})}
                                 placeholder="Target amount" type="number" className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-white"/>
                          <input value={newGoal.deadline} onChange={(e)=>setNewGoal({...newGoal, deadline: e.target.value})}
                                 type="date" className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-white"/>
                          <div className="flex space-x-2">
                            <button onClick={handleAddGoal} className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">Save</button>
                            <button onClick={() => setShowAddGoal(false)} className="bg-slate-600 hover:bg-slate-700 text-white px-4 py-2 rounded text-sm">Cancel</button>
                          </div>
                        </div>
                      </div>
                    )}
                    
                    <div className="space-y-4">
                      {goals.length > 0 ? goals.map(goal => (
                        <div key={goal.id} className="p-4 bg-slate-800 rounded-lg">
                          <div className="flex justify-between items-center mb-2">
                            <h4 className="text-white font-medium">{goal.name}</h4>
                            <span className="text-slate-400 text-sm">{new Date(goal.deadline).toLocaleDateString()}</span>
                          </div>
                          <div className="mb-2">
                            <div className="flex justify-between text-sm mb-1">
                              <span className="text-slate-400">Progress</span>
                              <span className="text-white">{currencySymbol}{goal.saved} / {currencySymbol}{goal.target}</span>
                            </div>
                            <div className="w-full bg-slate-700 rounded-full h-2">
                              <div className="bg-blue-600 h-2 rounded-full" style={{width: `${Math.min((goal.saved/goal.target)*100, 100)}%`}}></div>
                            </div>
                          </div>
                          <p className="text-xs text-slate-400">{((goal.saved/goal.target)*100).toFixed(1)}% complete</p>
                        </div>
                      )) : (
                        <div className="text-center py-8 text-slate-400">
                          <p>No goals yet. Add your first savings goal!</p>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Future Expenses */}
                  <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6">
                    <div className="flex justify-between items-center mb-6">
                      <h3 className="text-xl font-semibold text-white">📅 Future Expenses</h3>
                      <button onClick={() => setShowAddExpense(true)}
                              className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        Plan Expense
                      </button>
                    </div>
                    
                    {showAddExpense && (
                      <div className="mb-6 p-4 bg-slate-800 rounded-lg">
                        <h4 className="text-white font-medium mb-3">Plan Future Expense</h4>
                        <div className="space-y-3">
                          <input value={newExpense.name} onChange={(e)=>setNewExpense({...newExpense, name: e.target.value})}
                                 placeholder="Expense name" className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-white"/>
                          <input value={newExpense.amount} onChange={(e)=>setNewExpense({...newExpense, amount: e.target.value})}
                                 placeholder="Amount" type="number" className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-white"/>
                          <input value={newExpense.date} onChange={(e)=>setNewExpense({...newExpense, date: e.target.value})}
                                 type="date" className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-white"/>
                          <select value={newExpense.category} onChange={(e)=>setNewExpense({...newExpense, category: e.target.value})}
                                  className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-white">
                          <select value={newExpense.category} onChange={(e)=>setNewExpense({...newExpense, category: e.target.value})}
                                  className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-white">
                            <option>School Fees</option><option>Rent</option><option>Vacation</option><option>Insurance</option><option>Medical</option><option>Other</option>
                          </select>
                          <div className="flex space-x-2">
                            <button onClick={handleAddExpense} className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">Save</button>
                            <button onClick={() => setShowAddExpense(false)} className="bg-slate-600 hover:bg-slate-700 text-white px-4 py-2 rounded text-sm">Cancel</button>
                          </div>
                        </div>
                      </div>
                    )}
                    
                    <div className="space-y-4">
                      {futureExpenses.length > 0 ? futureExpenses.map(expense => (
                        <div key={expense.id} className="p-4 bg-slate-800 rounded-lg">
                          <div className="flex justify-between items-center mb-2">
                            <h4 className="text-white font-medium">{expense.name}</h4>
                            <span className="text-purple-400 font-medium">{currencySymbol}{expense.amount}</span>
                          </div>
                          <div className="flex justify-between items-center">
                            <span className="text-slate-400 text-sm">{expense.category}</span>
                            <span className="text-slate-400 text-sm">{new Date(expense.date).toLocaleDateString()}</span>
                          </div>
                        </div>
                      )) : (
                        <div className="text-center py-8 text-slate-400">
                          <p>No planned expenses. Start planning ahead!</p>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Enhanced Insights Section with AI Chat */}
            {activeSection === 'insights' && (
              <div>
                <div className="mb-8">
                  <h1 className="text-3xl font-bold text-white mb-2">Financial Insights</h1>
                  <p className="text-slate-400">AI-powered insights to improve your financial health</p>
                </div>
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                  {/* Smart Recommendations */}
                  <div className="lg:col-span-2 bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-xl font-semibold text-white">💡 Smart Recommendations</h3>
                      <button onClick={handleGenerateInsights} disabled={isGeneratingInsights}
                              className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center space-x-2 ${
                                isGeneratingInsights ? 'bg-slate-600 text-slate-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 text-white'
                              }`}>
                        {isGeneratingInsights ? (
                          <>
                            <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                            <span>Generating...</span>
                          </>
                        ) : (
                          <span>Generate New Insights</span>
                        )}
                      </button>
                    </div>
                    <div className="space-y-4 mb-6">
                      {insights.length > 0 ? (
                        insights.map((insight, index) => (
                          <div key={index} className={`border rounded-lg p-4 ${
                            insight.type === 'positive' ? 'bg-green-500/10 border-green-500/20' :
                            insight.type === 'negative' ? 'bg-red-500/10 border-red-500/20' :
                            'bg-blue-500/10 border-blue-500/20'
                          }`}>
                            <h4 className={`font-medium mb-2 ${
                              insight.type === 'positive' ? 'text-green-400' :
                              insight.type === 'negative' ? 'text-red-400' : 'text-blue-400'
                            }`}>{insight.title}</h4>
                            <p className="text-sm text-slate-300">{insight.recommendation}</p>
                          </div>
                        ))
                      ) : (
                        <div className="text-center py-8 text-slate-400">
                          <p>Click "Generate New Insights" to get personalized recommendations.</p>
                        </div>
                      )}
                    </div>
                    
                    {/* AI Chat Section */}
                    <div className="border-t border-slate-700 pt-6">
                      <h4 className="text-lg font-semibold text-white mb-4">🤖 Ask Clarity</h4>
                      <div className="bg-slate-800 rounded-lg p-4 h-64 overflow-y-auto mb-4">
                        {chatMessages.length > 0 ? (
                          chatMessages.map((msg, idx) => (
                            <div key={idx} className={`mb-3 ${msg.type === 'user' ? 'text-right' : 'text-left'}`}>
                              <div className={`inline-block p-3 rounded-lg max-w-xs ${
                                msg.type === 'user' ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-200'
                              }`}>
                                <p className="text-sm">{msg.message}</p>
                              </div>
                            </div>
                          ))
                        ) : (
                          <p className="text-slate-400 text-center">Ask me anything about your finances!</p>
                        )}
                        {isChatLoading && (
                          <div className="text-left mb-3">
                            <div className="inline-block p-3 rounded-lg bg-slate-700">
                              <div className="animate-pulse text-slate-400">Thinking...</div>
                            </div>
                          </div>
                        )}
                      </div>
                      <div className="flex space-x-2">
                        <input value={chatInput} onChange={(e)=>setChatInput(e.target.value)}
                               onKeyPress={(e)=>e.key==='Enter'&&handleSendChatMessage()}
                               placeholder="Ask about your spending, savings, or financial goals..."
                               className="flex-1 p-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:ring-2 focus:ring-blue-500"/>
                        <button onClick={handleSendChatMessage} disabled={!chatInput.trim() || isChatLoading}
                                className="px-4 py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-600 text-white rounded-lg transition-colors">
                          Send
                        </button>
                      </div>
                    </div>
                  </div>

                  {/* Spending Patterns */}
                  <div className="lg:col-span-1 bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6">
                    <h3 className="text-xl font-semibold text-white mb-4">📊 Spending Patterns</h3>
                    <div className="space-y-4">
                      <div className="flex justify-between items-center">
                        <span className="text-slate-300">Highest spending day</span>
                        <span className="text-white font-medium">{spendingPatterns.highestSpendingDay}</span>
                      </div>
                      <div className="flex justify-between items-center">
                        <span className="text-slate-300">Most frequent category</span>
                        <span className="text-white font-medium">{spendingPatterns.mostFrequentCategory}</span>
                      </div>
                      <div className="flex justify-between items-center">
                        <span className="text-slate-300">Average transaction</span>
                        <span className="text-white font-medium">{currencySymbol}{spendingPatterns.averageTransaction}</span>
                      </div>
                      <div className="flex justify-between items-center">
                        <span className="text-slate-300">Monthly trend</span>
                        <span className="text-red-400 font-medium">{spendingPatterns.monthlyTrend}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    // Main App Component
    const App = () => {
      const [user, setUser] = useState(null);
      const [isInitializing, setIsInitializing] = useState(true);
      const [error, setError] = useState('');

      useEffect(() => {
        const firebaseConfig = {
          apiKey: "AIzaSyCEwNa6knQpuCV_eLgKLr7m-88ufWP8484",
          authDomain: "financial-wellness-dashboard.firebaseapp.com",
          projectId: "financial-wellness-dashboard",
          storageBucket: "financial-wellness-dashboard.appspot.com",
          messagingSenderId: "599378817258",
          appId: "1:599378817258:web:95841307d6960986f36793"
        };

        try {
          if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
          const unsubscribe = firebase.auth().onAuthStateChanged((currentUser) => {
            setUser(currentUser);
            setIsInitializing(false);
          });
          return () => unsubscribe();
        } catch (err) {
          console.error("Firebase init error:", err);
          setError("Failed to initialize app");
          setIsInitializing(false);
        }
      }, []);

      if (isInitializing) {
        return (
          <div className="flex items-center justify-center min-h-screen bg-slate-950">
            <div className="text-center">
              <div className="text-4xl font-bold gradient-text mb-4">Clarity</div>
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
              <p className="text-slate-400 mt-4">Loading your dashboard...</p>
            </div>
          </div>
        );
      }

      if (error) {
        return (
          <div className="flex items-center justify-center min-h-screen bg-slate-950">
            <div className="text-center">
              <div className="text-red-400 text-xl mb-4">⚠️ Error</div>
              <p className="text-slate-400">{error}</p>
            </div>
          </div>
        );
      }

      return user ? <FinancialDashboard user={user}/> : <LoginPage setError={setError}/>;
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
