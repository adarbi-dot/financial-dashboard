<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Clarity - Financial Wellness Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <!-- React + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap">
  <style>
    body { font-family: 'DM Sans', sans-serif; }
    .gradient-text {
      background: linear-gradient(to right, #38bdf8, #a78bfa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .card-hover { transition: transform .2s ease, box-shadow .2s ease; }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,.2); }
  </style>
</head>
<body class="bg-slate-950 text-slate-300">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    // Helper data
    const exchangeRates = { USD: 1, AED: 3.67, EUR: 1.08, GBP: 1.25 };
    const categories = {
      'Personal Expense': ['Groceries', 'Rent', 'Utilities', 'Entertainment', 'Transportation', 'Subscriptions', 'Other Personal'],
      'Business Expense': ['Software', 'Freelance Tools', 'Co-working Space', 'Marketing', 'Education', 'Other Business'],
      'Income': ['Client Work', 'Bonus', 'Tips', 'Salary', 'Other Income']
    };
    const currencies = [
      { code: 'USD', symbol: '$' },
      { code: 'AED', symbol: 'د.إ' },
      { code: 'EUR', symbol: '€' },
      { code: 'GBP', symbol: '£' }
    ];
    const getSymbol = (code) => currencies.find(c => c.code === code)?.symbol || '';
    const formatDate = (dateString) => new Date(dateString).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

    // Login Page Component
    const LoginPage = ({ setError }) => {
      const [isLogin, setIsLogin] = useState(true);
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');

      const handleAuthAction = async (e) => {
        e.preventDefault();
        setError('');
        try {
          if (isLogin) await firebase.auth().signInWithEmailAndPassword(email, password);
          else await firebase.auth().createUserWithEmailAndPassword(email, password);
        } catch (err) { setError(err.message); }
      };

      return (
        <div className="flex items-center justify-center min-h-screen bg-slate-950">
          <div className="w-full max-w-md p-8 space-y-6 bg-slate-900 rounded-2xl shadow-2xl">
            <div className="text-center">
              <h1 className="text-4xl font-extrabold gradient-text">Clarity</h1>
              <p className="text-slate-400 mt-2">{isLogin ? 'Welcome back, log in to continue' : 'Create an account to get started'}</p>
            </div>
            <form onSubmit={handleAuthAction} className="space-y-6">
              <div>
                <label className="block text-sm font-medium mb-1 text-slate-400">Email Address</label>
                <input type="email" value={email} onChange={(e)=>setEmail(e.target.value)} required
                       className="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 focus:ring-2 focus:ring-blue-500 text-white"
                       placeholder="you@example.com"/>
              </div>
              <div>
                <label className="block text-sm font-medium mb-1 text-slate-400">Password</label>
                <input type="password" value={password} onChange={(e)=>setPassword(e.target.value)} required
                       className="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 focus:ring-2 focus:ring-blue-500 text-white"
                       placeholder="••••••••"/>
              </div>
              <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                {isLogin ? 'Login' : 'Sign Up'}
              </button>
            </form>
            <p className="text-center text-sm text-slate-400">
              {isLogin ? "Don't have an account? " : "Already have an account? "}
              <button onClick={() => { setIsLogin(!isLogin); setError(''); }} className="font-medium text-blue-400 hover:underline">
                {isLogin ? 'Sign Up' : 'Login'}
              </button>
            </p>
          </div>
        </div>
      );
    };

    // Financial Dashboard Component
    const FinancialDashboard = ({ user }) => {
      const [transactions, setTransactions] = useState([]);
      const [baseCurrency, setBaseCurrency] = useState(localStorage.getItem('userBaseCurrency') || 'USD');
      const [activeSection, setActiveSection] = useState('dashboard');

      // Importer
      const [pastedText, setPastedText] = useState('');
      const [isParsing, setIsParsing] = useState(false);
      const [message, setMessage] = useState('');

      // Insights
      const [insights, setInsights] = useState([]);
      const [isGeneratingInsights, setIsGeneratingInsights] = useState(false);

      useEffect(() => {
        if (!user) return;
        const transactionsRef = firebase.firestore().collection(`users/${user.uid}/transactions`);
        const unsubscribe = transactionsRef.onSnapshot((snapshot) => {
          const fetched = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          fetched.sort((a, b) => new Date(b.date) - new Date(a.date));
          setTransactions(fetched);
        });
        return () => unsubscribe();
      }, [user]);

      const totals = useMemo(() => {
        let totalIncome = 0, totalExpense = 0;
        transactions.forEach(t => {
          const rate = exchangeRates[t.currency] || 1;
          const baseRate = exchangeRates[baseCurrency] || 1;
          const convertedAmount = t.amount * (rate / baseRate);
          if (t.type === 'Income') totalIncome += convertedAmount;
          else totalExpense += convertedAmount;
        });
        return {
          income: totalIncome.toFixed(2),
          expense: totalExpense.toFixed(2),
          net: (totalIncome - totalExpense).toFixed(2)
        };
      }, [transactions, baseCurrency]);

      const categoryBreakdown = useMemo(() => {
        const breakdown = {};
        transactions.forEach(t => {
          if (t.type !== 'Income') {
            const rate = exchangeRates[t.currency] || 1;
            const baseRate = exchangeRates[baseCurrency] || 1;
            const convertedAmount = t.amount * (rate / baseRate);
            breakdown[t.subcategory] = (breakdown[t.subcategory] || 0) + convertedAmount;
          }
        });
        return Object.entries(breakdown).sort((a,b)=>b[1]-a[1]).slice(0,5);
      }, [transactions, baseCurrency]);

      const handleSignOut = async () => {
        try { await firebase.auth().signOut(); } catch (e) { console.error(e); }
      };

      const handleParseText = async () => {
        if (!pastedText.trim()) { setMessage('Please paste text to import.'); return; }
        setIsParsing(true);
        setMessage('Analyzing with AI...');
        try {
          const apiKey = "AIzaSyCEwNa6knQpuCV_eLgKLr7m-88ufWP8484";
          const prompt = `You are an expert data extraction tool. Return ONLY a valid JSON array of transactions from the user's text in YYYY-MM-DD format for date, number for amount, three-letter currency code, and type 'Income' or 'Expense'. Text: ${pastedText}`;
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
          });
          const result = await response.json();
          const rawJsonText = result.candidates[0].content.parts[0].text;
          const match = rawJsonText.match(/\[.*\]/s);
          if (!match) throw new Error("AI did not return a valid JSON array.");
          const parsedTransactions = JSON.parse(match[0]);
          const batch = firebase.firestore().batch();
          const transactionsCollectionRef = firebase.firestore().collection(`users/${user.uid}/transactions`);
          let transactionsAdded = 0;
          parsedTransactions.forEach(transaction => {
            if (transaction.date && !isNaN(new Date(transaction.date)) && transaction.amount) {
              const newRef = transactionsCollectionRef.doc();
              batch.set(newRef, transaction);
              transactionsAdded++;
            }
          });
          if (transactionsAdded === 0) throw new Error("No valid transactions found.");
          await batch.commit();
          setMessage(`Successfully imported ${transactionsAdded} transactions!`);
          setPastedText('');
        } catch (error) {
          console.error("Error during import:", error);
          setMessage(`Import Error: ${error.message}`);
        } finally
