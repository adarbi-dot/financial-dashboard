<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clarity - Financial Wellness Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- React and Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap">
    <style>
        body {
            font-family: 'DM Sans', sans-serif;
        }
        .gradient-text {
            background: linear-gradient(to right, #38bdf8, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .card-hover {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        }
        .progress-bar {
            background: linear-gradient(90deg, #38bdf8, #a78bfa);
        }
        .section-content {
            display: none;
        }
        .section-content.active {
            display: block;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-300">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Helper Functions and Data ---
        const exchangeRates = { 'USD': 1, 'AED': 3.67, 'EUR': 1.08, 'GBP': 1.25 };
        const categories = {
            'Personal Expense': ['Groceries', 'Rent', 'Utilities', 'Entertainment', 'Transportation', 'Subscriptions', 'Other Personal'],
            'Business Expense': ['Software', 'Freelance Tools', 'Co-working Space', 'Marketing', 'Education', 'Other Business'],
            'Income': ['Client Work', 'Bonus', 'Tips', 'Salary', 'Other Income']
        };
        const currencies = [ { code: 'USD', symbol: '$' }, { code: 'AED', symbol: 'د.إ' }, { code: 'EUR', symbol: '€' }, { code: 'GBP', symbol: '£' } ];
        const getSymbol = (code) => currencies.find(c => c.code === code)?.symbol || '';
        const formatDate = (dateString) => new Date(dateString).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

        // --- Login Page Component ---
        const LoginPage = ({ auth, setError, setMessage }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');

            const handleAuthAction = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    if (isLogin) {
                        await firebase.auth().signInWithEmailAndPassword(email, password);
                    } else {
                        await firebase.auth().createUserWithEmailAndPassword(email, password);
                    }
                } catch (error) {
                    setError(error.message);
                }
            };

            return (
                <div className="flex items-center justify-center min-h-screen bg-slate-950">
                    <div className="w-full max-w-md p-8 space-y-6 bg-slate-900 rounded-2xl shadow-2xl">
                        <div className="text-center">
                            <h1 className="text-4xl font-extrabold gradient-text">Clarity</h1>
                            <p className="text-slate-400 mt-2">{isLogin ? 'Welcome back, log in to continue' : 'Create an account to get started'}</p>
                        </div>
                        <form onSubmit={handleAuthAction} className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium mb-1 text-slate-400">Email Address</label>
                                <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} required className="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 focus:ring-2 focus:ring-blue-500 text-white" placeholder="you@example.com" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1 text-slate-400">Password</label>
                                <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} required className="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 focus:ring-2 focus:ring-blue-500 text-white" placeholder="••••••••" />
                            </div>
                            <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">{isLogin ? 'Login' : 'Sign Up'}</button>
                        </form>
                        <p className="text-center text-sm text-slate-400">{isLogin ? "Don't have an account? " : "Already have an account? "}<button onClick={() => { setIsLogin(!isLogin); setError(''); }} className="font-medium text-blue-400 hover:underline">{isLogin ? 'Sign Up' : 'Login'}</button></p>
                    </div>
                </div>
            );
        };

        // --- Main Application Component ---
        const FinancialDashboard = ({ user, db, auth }) => {
            const [transactions, setTransactions] = useState([]);
            const [baseCurrency, setBaseCurrency] = useState(localStorage.getItem('userBaseCurrency') || 'USD');
            const [activeSection, setActiveSection] = useState('dashboard');
            const [pastedText, setPastedText] = useState('');
            const [isParsing, setIsParsing] = useState(false);
            const [pendingTransactions, setPendingTransactions] = useState([]);
            const [message, setMessage] = useState('');
            const chatEndRef = useRef(null);
            const [chatHistory, setChatHistory] = useState([]);
            const [chatInput, setChatInput] = useState('');
            const [isChatting, setIsChatting] = useState(false);
            
            useEffect(() => {
                if (!db || !user) return;
                const transactionsRef = firebase.firestore().collection(`users/${user.uid}/transactions`);
                const unsubscribe = transactionsRef.onSnapshot((snapshot) => {
                    const fetched = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    fetched.sort((a, b) => new Date(b.date) - new Date(a.date));
                    setTransactions(fetched);
                });
                return () => unsubscribe();
            }, [db, user]);

            useEffect(() => {
                if (chatEndRef.current) {
                    chatEndRef.current.scrollTop = chatEndRef.current.scrollHeight;
                }
            }, [chatHistory]);

            const totals = useMemo(() => {
                let totalIncome = 0;
                let totalExpense = 0;
                transactions.forEach(t => {
                    const rate = exchangeRates[t.currency] || 1;
                    const baseRate = exchangeRates[baseCurrency] || 1;
                    const convertedAmount = t.amount * (rate / baseRate);
                    if (t.type === 'Income') totalIncome += convertedAmount;
                    else totalExpense += convertedAmount;
                });
                return {
                    income: totalIncome.toFixed(2),
                    expense: totalExpense.toFixed(2),
                    net: (totalIncome - totalExpense).toFixed(2)
                };
            }, [transactions, baseCurrency]);

            const recentTransactions = transactions.slice(0, 5);
            const userName = user.email.split('@')[0];
            const currencySymbol = getSymbol(baseCurrency);

            const categoryBreakdown = useMemo(() => {
                const breakdown = {};
                transactions.forEach(t => {
                    if (t.type !== 'Income') {
                        const rate = exchangeRates[t.currency] || 1;
                        const baseRate = exchangeRates[baseCurrency] || 1;
                        const convertedAmount = t.amount * (rate / baseRate);
                        breakdown[t.subcategory] = (breakdown[t.subcategory] || 0) + convertedAmount;
                    }
                });
                return Object.entries(breakdown)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5);
            }, [transactions, baseCurrency]);

            const handleSignOut = async () => {
                try {
                    await firebase.auth().signOut();
                } catch (error) {
                    console.error('Error signing out:', error);
                }
            };

            const handleSendMessage = async () => {
                if (isChatting || !chatInput.trim()) return;
                
                const userMessage = { role: 'user', content: chatInput };
                const newChatHistory = [...chatHistory, userMessage];
                setChatHistory(newChatHistory);
                setChatInput('');
                setIsChatting(true);
                
                try {
                    const apiKey = "AIzaSyCEwNa6knQpuCV_eLgKLr7m-88ufWP8484";
                    const prompt = `
                    You are a professional and empathetic financial coach named Clarity. Your goal is to provide clear, actionable, and encouraging advice based on the user's financial data and their questions. Do not use markdown formatting.

                    FINANCIAL DATA SUMMARY:
                    - Total Income: ${totals.income} ${baseCurrency}
                    - Total Expenses: ${totals.expense} ${baseCurrency}
                    - Net Flow: ${totals.net} ${baseCurrency}
                    - Recent Transactions (JSON): ${JSON.stringify(transactions.slice(0, 10))}

                    CONVERSATION HISTORY:
                    ${newChatHistory.map(msg => `${msg.role}: ${msg.content}`).join('\n')}

                    Based on all the data above, provide a helpful and concise response to the user's latest question.
                    Assistant:
                    `;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] } )
                    });

                    if (!response.ok) {
                        throw new Error("The AI is currently unavailable. Please try again later.");
                    }

                    const result = await response.json();
                    const aiMessage = result.candidates[0].content.parts[0].text;
                    setChatHistory(prev => [...prev, { role: 'assistant', content: aiMessage.trim() }]);

                } catch (error) {
                    setChatHistory(prev => [...prev, { role: 'assistant', content: `Sorry, I encountered an error: ${error.message}` }]);
                } finally {
                    setIsChatting(false);
                }
            };

            const handleParseText = async () => {
                if (!pastedText.trim()) {
                    setMessage('Please paste text to import.');
                    return;
                }
                setIsParsing(true);
                setMessage('Analyzing with AI...');
                  const tempId = `pending-${Date.now()}`;
                setPendingTransactions([{ id: tempId, description: 'Analyzing your pasted text...' }]);
                try {
                    const apiKey = "AIzaSyCEwNa6knQpuCV_eLgKLr7m-88ufWP8484";
                    const prompt = `
                    You are a highly accurate data extraction tool. Your ONLY job is to convert the user's text into a valid JSON array of financial transactions.     
                    **RULES:**
                    1.  **Currency is CRITICAL.** You MUST identify the currency for each transaction. If the user provides a currency symbol or code (e.g., $, AED, £, EUR), you MUST use the corresponding three-letter code ('USD', 'AED', 'GBP', 'EUR').
                    2.  **Date is CRITICAL.** You MUST provide a valid date in YYYY-MM-DD format. If no date is provided for a transaction, exclude it from the output.
                    3.  **Amount is CRITICAL.** The 'amount' field must be a number only, with no symbols.
                    4.  **NEVER** output any text, explanation, or conversation. Your entire response must be ONLY the JSON array. 
                    **AVAILABLE CATEGORIES:**
                    - Personal Expense: ${categories['Personal Expense'].join(', ')}
                    - Business Expense: ${categories['Business Expense'].join(', ')}
                    - Income: ${categories['Income'].join(', ')}
             
                    **USER'S TEXT TO PARSE:**
                    ---
                    ${pastedText}
                    ---
                    `;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] } )
                    });
                    if (!response.ok) {
                        throw new Error(`AI API Error: ${response.statusText}`);
                    }
                    const result = await response.json();
                    const rawJsonText = result.candidates[0].content.parts[0].text;
                    // Robust JSON parsing
                    const match = rawJsonText.match(/\[.*\]/s);
                    if (!match) {
                        throw new Error("AI did not return a valid JSON array.");
                    }
                    const parsedTransactions = JSON.parse(match[0]);
                    const batch = firebase.firestore().batch();
                    const transactionsCollectionRef = firebase.firestore().collection(`users/${user.uid}/transactions`);
                    let transactionsAdded = 0;
                    parsedTransactions.forEach(transaction => {
                        if (transaction.date && !isNaN(new Date(transaction.date))) {
                            const newTransactionRef = transactionsCollectionRef.doc();
                            batch.set(newTransactionRef, transaction);
                            transactionsAdded++;
                        }
                    });
                    await batch.commit();
                    setMessage(`Successfully imported ${transactionsAdded} transactions!`);
                    setPastedText('');
                } catch (error) {
                    console.error("Error during import:", error);
                    setMessage(`Import Error: ${error.message}`);
                } finally {
                    setIsParsing(false);
                    setPendingTransactions([]);
                }
            };

            const showSection = (sectionId) => {
                setActiveSection(sectionId);
            };

            return (
                <div>
                    {/* Navigation */}
                    <nav className="bg-slate-900/50 backdrop-blur-sm border-b border-slate-800 sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-16">
                                <div className="flex items-center">
                                    <div className="text-2xl font-bold gradient-text">Clarity</div>
                                </div>
                                <div className="hidden md:block">
                                    <div className="ml-10 flex items-baseline space-x-4">
                                        <button onClick={() => showSection('dashboard')} className={`px-3 py-2 rounded-md text-sm font-medium ${activeSection === 'dashboard' ? 'text-blue-400' : 'text-slate-300 hover:text-white'}`}>Dashboard</button>
                                        <button onClick={() => showSection('transactions')} className={`px-3 py-2 rounded-md text-sm font-medium ${activeSection === 'transactions' ? 'text-blue-400' : 'text-slate-300 hover:text-white'}`}>Transactions</button>
                                        <button onClick={() => showSection('goals')} className={`px-3 py-2 rounded-md text-sm font-medium ${activeSection === 'goals' ? 'text-blue-400' : 'text-slate-300 hover:text-white'}`}>Goals</button>
                                        <button onClick={() => showSection('insights')} className={`px-3 py-2 rounded-md text-sm font-medium ${activeSection === 'insights' ? 'text-blue-400' : 'text-slate-300 hover:text-white'}`}>Insights</button>
                                    </div>
                                </div>
                                <div className="flex items-center space-x-4">
                                    <button onClick={handleSignOut} className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                        Sign Out
                                    </button>
                                    <div className="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full"></div>
                                </div>
                            </div>
                        </div>
                    </nav>

                    {/* Main Content Container */}
                    
const FinancialDashboard = ({ user, db, auth }) => {
    // Data States
    const [transactions, setTransactions] = useState([]);
    const [baseCurrency, setBaseCurrency] = useState(localStorage.getItem('userBaseCurrency') || 'USD');
    
    // UI States
    const [activeSection, setActiveSection] = useState('dashboard');
    const [message, setMessage] = useState('');

    // Importer States
    const [pastedText, setPastedText] = useState('');
    const [isParsing, setIsParsing] = useState(false);
    const [pendingTransactions, setPendingTransactions] = useState([]);

    // AI Coach States
    const chatEndRef = useRef(null);
    const [chatHistory, setChatHistory] = useState([]);
    const [chatInput, setChatInput] = useState('');
    const [isChatting, setIsChatting] = useState(false);

    // --- Data Fetching and Calculations ---
    useEffect(() => {
        if (!db || !user) return;
        const transactionsRef = firebase.firestore().collection(`users/${user.uid}/transactions`);
        const unsubscribe = transactionsRef.onSnapshot((snapshot) => {
            const fetched = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            fetched.sort((a, b) => new Date(b.date) - new Date(a.date));
            setTransactions(fetched);
        });
        return () => unsubscribe();
    }, [db, user]);

    useEffect(() => {
        if (chatEndRef.current) {
            chatEndRef.current.scrollTop = chatEndRef.current.scrollHeight;
        }
    }, [chatHistory]);

    const totals = useMemo(() => {
        let totalIncome = 0;
        let totalExpense = 0;
        transactions.forEach(t => {
            const rate = exchangeRates[t.currency] || 1;
            const baseRate = exchangeRates[baseCurrency] || 1;
            const convertedAmount = t.amount * (rate / baseRate);
            if (t.type === 'Income') totalIncome += convertedAmount;
            else totalExpense += convertedAmount;
        });
        return {
            income: totalIncome.toFixed(2),
            expense: totalExpense.toFixed(2),
            net: (totalIncome - totalExpense).toFixed(2)
        };
    }, [transactions, baseCurrency]);

    const recentTransactions = transactions.slice(0, 5);
    const userName = user.email.split('@')[0];
    const currencySymbol = getSymbol(baseCurrency);

    const categoryBreakdown = useMemo(() => {
        const breakdown = {};
        transactions.forEach(t => {
            if (t.type !== 'Income' && t.subcategory) {
                const rate = exchangeRates[t.currency] || 1;
                const baseRate = exchangeRates[baseCurrency] || 1;
                const convertedAmount = t.amount * (rate / baseRate);
                breakdown[t.subcategory] = (breakdown[t.subcategory] || 0) + convertedAmount;
            }
        });
        return Object.entries(breakdown)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 5);
    }, [transactions, baseCurrency]);

    // --- Event Handlers ---
    const handleSignOut = async () => {
        try {
            await firebase.auth().signOut();
        } catch (error) {
            console.error('Error signing out:', error);
        }
    };

    const handleSendMessage = async () => {
        if (isChatting || !chatInput.trim()) return;
        const userMessage = { role: 'user', content: chatInput };
        setChatHistory(prev => [...prev, userMessage]);
        setChatInput('');
        setIsChatting(true);
        
        try {
            const apiKey = "AIzaSyCEwNa6knQpuCV_eLgKLr7m-88ufWP8484";
            const prompt = `You are Clarity, a helpful financial coach. Analyze the user's financial data and conversation to answer their question. Be concise and encouraging. Financial Data: Net Balance=${totals.net} ${baseCurrency}, Total Income=${totals.income} ${baseCurrency}, Total Expenses=${totals.expense} ${baseCurrency}. Recent Transactions: ${JSON.stringify(transactions.slice(0,5))}. Conversation History: ${chatHistory.map(m=>`${m.role}:${m.content}`).join(', ')}. User Question: ${userMessage.content}. Assistant:`;
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] } )
            });
            if (!response.ok) throw new Error(`AI service returned an error: ${response.statusText}`);
            const result = await response.json();
            const aiMessage = result.candidates[0].content.parts[0].text;
            setChatHistory(prev => [...prev, { role: 'assistant', content: aiMessage.trim() }]);
        } catch (error) {
            setChatHistory(prev => [...prev, { role: 'assistant', content: `Sorry, I encountered an error: ${error.message}` }]);
        } finally {
            setIsChatting(false);
        }
    };

    const handleParseText = async () => {
        if (!pastedText.trim()) { setMessage('Please paste text to import.'); return; }
        setIsParsing(true);
        setMessage('Analyzing with AI...');
        const tempId = `pending-${Date.now()}`;
        setPendingTransactions([{ id: tempId, description: 'Analyzing your pasted text...' }]);
        
        try {
            const apiKey = "AIzaSyCEwNa6knQpuCV_eLgKLr7m-88ufWP8484";
            const prompt = `You are a data extraction tool. Convert the user's text into a valid JSON array of transactions. Rules: 1. Use three-letter currency codes (USD, AED, etc.). 2. Use YYYY-MM-DD format for dates. 3. Amount must be a number. 4. ONLY output the JSON array. Available Categories: Personal Expense: ${categories['Personal Expense'].join(', ')}. Business Expense: ${categories['Business Expense'].join(', ')}. Income: ${categories['Income'].join(', ')}. USER'S TEXT: --- ${pastedText} ---`;
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] } )
            });
            if (!response.ok) throw new Error(`AI API Error: ${response.statusText}`);
            const result = await response.json();
            const rawJsonText = result.candidates[0].content.parts[0].text;
            const match = rawJsonText.match(/\[.*\]/s);
            if (!match) throw new Error("AI did not return a valid JSON array.");
            const parsedTransactions = JSON.parse(match[0]);
            
            const batch = firebase.firestore().batch();
            const transactionsCollectionRef = firebase.firestore().collection(`users/${user.uid}/transactions`);
            let transactionsAdded = 0;
            parsedTransactions.forEach(transaction => {
                if (transaction.date && !isNaN(new Date(transaction.date))) {
                    const newTransactionRef = transactionsCollectionRef.doc();
                    batch.set(newTransactionRef, transaction);
                    transactionsAdded++;
                }
            });
            await batch.commit();
            setMessage(`Successfully imported ${transactionsAdded} transactions!`);
            setPastedText('');
        } catch (error) {
            console.error("Error during import:", error);
            setMessage(`Import Error: ${error.message}`);
        } finally {
            setIsParsing(false);
            setPendingTransactions([]);
        }
    };

    const showSection = (sectionId) => {
        setActiveSection(sectionId);
    };

    // --- JSX Return ---
    return (
        <div>
            {/* Navigation */}
            <nav className="bg-slate-900/50 backdrop-blur-sm border-b border-slate-800 sticky top-0 z-50">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div className="flex justify-between items-center h-16">
                        <div className="flex items-center"><div className="text-2xl font-bold gradient-text">Clarity</div></div>
                        <div className="hidden md:block"><div className="ml-10 flex items-baseline space-x-4">
                            <button onClick={() => showSection('dashboard')} className={`px-3 py-2 rounded-md text-sm font-medium ${activeSection === 'dashboard' ? 'text-blue-400' : 'text-slate-300 hover:text-white'}`}>Dashboard</button>
                            <button onClick={() => showSection('transactions')} className={`px-3 py-2 rounded-md text-sm font-medium ${activeSection === 'transactions' ? 'text-blue-400' : 'text-slate-300 hover:text-white'}`}>Transactions</button>
                            <button onClick={() => showSection('goals')} className={`px-3 py-2 rounded-md text-sm font-medium ${activeSection === 'goals' ? 'text-blue-400' : 'text-slate-300 hover:text-white'}`}>Goals</button>
                            <button onClick={() => showSection('insights')} className={`px-3 py-2 rounded-md text-sm font-medium ${activeSection === 'insights' ? 'text-blue-400' : 'text-slate-300 hover:text-white'}`}>Insights</button>
                        </div></div>
                        <div className="flex items-center space-x-4">
                            <button onClick={handleSignOut} className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">Sign Out</button>
                            <div className="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full"></div>
                        </div>
                    </div>
                </div>
            </nav>

            {/* Main Content Container */}
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                {/* Dashboard Section */}
                {activeSection === 'dashboard' && (
                    <div>
                        <div className="mb-8"><h1 className="text-3xl font-bold text-white mb-2">Welcome back, {userName}! 👋</h1><p className="text-slate-400">Here's your financial overview for this month</p></div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            {/* Cards go here, same as your code */}
                        </div>
                        {/* Charts and Recent Transactions go here, same as your code */}
                    </div>
                )}

                {/* Transactions Section */}
                {activeSection === 'transactions' && (
                    <div>
                        {/* ... your existing beautiful transactions section ... */}
                    </div>
                )}

                {/* Goals Section */}
                {activeSection === 'goals' && (
                    <div>
                        {/* ... your existing beautiful goals section ... */}
                    </div>
                )}

                {/* Insights Section (AI Coach) */}
                {activeSection === 'insights' && (
                    <div>
                        <div className="mb-8"><h1 className="text-3xl font-bold text-white mb-2">AI Financial Coach</h1><p className="text-slate-400">Ask questions about your finances to get personalized, AI-powered advice.</p></div>
                        <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6">
                            <div className="flex flex-col h-96">
                                <div ref={chatEndRef} className="flex-1 overflow-y-auto p-4 bg-slate-800 rounded-lg mb-4 space-y-4">
                                    {chatHistory.length === 0 && (<div className="text-center text-slate-400 h-full flex flex-col justify-center items-center"><div className="text-5xl mb-4">🤖</div><p>Ask a question to get started.</p><p className="text-sm text-slate-500">e.g., "How can I reduce my spending?"</p></div>)}
                                    {chatHistory.map((message, index) => (<div key={index} className={`flex items-start gap-3 ${message.role === 'user' ? 'justify-end' : ''}`}>{message.role === 'assistant' && (<div className="w-8 h-8 bg-slate-700 rounded-full flex-shrink-0 flex items-center justify-center">🤖</div>)}<div className={`p-3 rounded-lg max-w-lg ${message.role === 'user' ? 'bg-blue-600 text-white' : 'bg-slate-700'}`}><p className="whitespace-pre-wrap">{message.content}</p></div></div>))}
                                </div>
                                <div className="flex items-center gap-2">
                                    <input type="text" value={chatInput} onChange={(e) => setChatInput(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter' && !isChatting) handleSendMessage(); }} placeholder="Ask a financial question..." className="flex-1 p-3 rounded-lg bg-slate-800 border border-slate-700 text-gray-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500" disabled={isChatting}/>
                                    <button onClick={handleSendMessage} disabled={isChatting || !chatInput.trim()} className={`p-3 rounded-lg font-semibold transition-colors shadow-lg flex items-center justify-center w-24 ${isChatting || !chatInput.trim() ? 'bg-slate-600 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}`}>{isChatting ? <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div> : "Ask"}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};


        // --- App Gatekeeper ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [auth, setAuth] = useState(null);
            const [db, setDb] = useState(null);
            const [isInitializing, setIsInitializing] = useState(true);
            const [error, setError] = useState('');

            useEffect(() => {
                const firebaseConfig = {
                    apiKey: "AIzaSyCEwNa6knQpuCV_eLgKLr7m-88ufWP8484",
                    authDomain: "financial-wellness-dashboard.firebaseapp.com",
                    projectId: "financial-wellness-dashboard",
                    storageBucket: "financial-wellness-dashboard.appspot.com",
                    messagingSenderId: "599378817258",
                    appId: "1:599378817258:web:95841307d6960986f36793"
                };

                try {
                    firebase.initializeApp(firebaseConfig);
                    const authInstance = firebase.auth();
                    const dbInstance = firebase.firestore();
                    setAuth(authInstance);
                    setDb(dbInstance);
                    
                    const unsubscribe = authInstance.onAuthStateChanged((currentUser) => {
                        setUser(currentUser);
                        setIsInitializing(false);
                    });
                    return () => unsubscribe();
                } catch (error) {
                    console.error("Error initializing Firebase:", error);
                    setError("Failed to initialize app");
                    setIsInitializing(false);
                }
            }, []);

            if (isInitializing) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-slate-950">
                        <div className="text-center">
                            <div className="text-4xl font-bold gradient-text mb-4">Clarity</div>
                            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
                            <p className="text-slate-400 mt-4">Loading your dashboard...</p>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-slate-950">
                        <div className="text-center">
                            <div className="text-red-400 text-xl mb-4">⚠️ Error</div>
                            <p className="text-slate-400">{error}</p>
                        </div>
                    </div>
                );
            }

            return user ? <FinancialDashboard user={user} db={db} auth={auth} /> : <LoginPage auth={auth} setError={setError} />;
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>

<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97d0c3b904e4c71e',t:'MTc1NzUyNjU5My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
