<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Clarity - Financial Wellness Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <!-- React + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap">
  <style>
    body { font-family: 'DM Sans', sans-serif; }
    .gradient-text {
      background: linear-gradient(to right, #38bdf8, #a78bfa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .card-hover { transition: transform .2s ease, box-shadow .2s ease; }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,.2); }
  </style>
</head>
<body class="bg-slate-950 text-slate-300">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    // Helper data
    const exchangeRates = { USD: 1, AED: 3.67, EUR: 1.08, GBP: 1.25 };
    const categories = {
      'Personal Expense': ['Groceries', 'Rent', 'Utilities', 'Entertainment', 'Transportation', 'Subscriptions', 'Other Personal'],
      'Business Expense': ['Software', 'Freelance Tools', 'Co-working Space', 'Marketing', 'Education', 'Other Business'],
      'Income': ['Client Work', 'Bonus', 'Tips', 'Salary', 'Other Income']
    };
    const currencies = [
      { code: 'USD', symbol: '$' },
      { code: 'AED', symbol: 'د.إ' },
      { code: 'EUR', symbol: '€' },
      { code: 'GBP', symbol: '£' }
    ];
    const getSymbol = (code) => currencies.find(c => c.code === code)?.symbol || '';
    const formatDate = (dateString) => new Date(dateString).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

    // Login
    const LoginPage = ({ auth, setError }) => {
      const [isLogin, setIsLogin] = useState(true);
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');

      const handleAuthAction = async (e) => {
        e.preventDefault();
        setError('');
        try {
          if (isLogin) await firebase.auth().signInWithEmailAndPassword(email, password);
          else await firebase.auth().createUserWithEmailAndPassword(email, password);
        } catch (err) { setError(err.message); }
      };

      return (
        <div className="flex items-center justify-center min-h-screen bg-slate-950">
          <div className="w-full max-w-md p-8 space-y-6 bg-slate-900 rounded-2xl shadow-2xl">
            <div className="text-center">
              <h1 className="text-4xl font-extrabold gradient-text">Clarity</h1>
              <p className="text-slate-400 mt-2">{isLogin ? 'Welcome back, log in to continue' : 'Create an account to get started'}</p>
            </div>
            <form onSubmit={handleAuthAction} className="space-y-6">
              <div>
                <label className="block text-sm font-medium mb-1 text-slate-400">Email Address</label>
                <input type="email" value={email} onChange={(e)=>setEmail(e.target.value)} required
                       className="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 focus:ring-2 focus:ring-blue-500 text-white"
                       placeholder="you@example.com"/>
              </div>
              <div>
                <label className="block text-sm font-medium mb-1 text-slate-400">Password</label>
                <input type="password" value={password} onChange={(e)=>setPassword(e.target.value)} required
                       className="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 focus:ring-2 focus:ring-blue-500 text-white"
                       placeholder="••••••••"/>
              </div>
              <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                {isLogin ? 'Login' : 'Sign Up'}
              </button>
            </form>
            <p className="text-center text-sm text-slate-400">
              {isLogin ? "Don't have an account? " : "Already have an account? "}
              <button onClick={() => { setIsLogin(!isLogin); setError(''); }} className="font-medium text-blue-400 hover:underline">
                {isLogin ? 'Sign Up' : 'Login'}
              </button>
            </p>
          </div>
        </div>
      );
    };

    // App
    const FinancialDashboard = ({ user }) => {
      const [transactions, setTransactions] = useState([]);
      const [baseCurrency, setBaseCurrency] = useState(localStorage.getItem('userBaseCurrency') || 'USD');
      const [activeSection, setActiveSection] = useState('dashboard');

      // Importer
      const [pastedText, setPastedText] = useState('');
      const [isParsing, setIsParsing] = useState(false);
      const [message, setMessage] = useState('');

      // New: Insights state for the new layout
      const [insights, setInsights] = useState([]);
      const [isGeneratingInsights, setIsGeneratingInsights] = useState(false);

      useEffect(() => {
        if (!user) return;
        const transactionsRef = firebase.firestore().collection(`users/${user.uid}/transactions`);
        const unsubscribe = transactionsRef.onSnapshot((snapshot) => {
          const fetched = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          fetched.sort((a, b) => new Date(b.date) - new Date(a.date));
          setTransactions(fetched);
        });
        return () => unsubscribe();
      }, [user]);

      const totals = useMemo(() => {
        let totalIncome = 0, totalExpense = 0;
        transactions.forEach(t => {
          const rate = exchangeRates[t.currency] || 1;
          const baseRate = exchangeRates[baseCurrency] || 1;
          const convertedAmount = t.amount * (rate / baseRate);
          if (t.type === 'Income') totalIncome += convertedAmount;
          else totalExpense += convertedAmount;
        });
        return {
          income: totalIncome.toFixed(2),
          expense: totalExpense.toFixed(2),
          net: (totalIncome - totalExpense).toFixed(2)
        };
      }, [transactions, baseCurrency]);

      const recentTransactions = transactions.slice(0, 5);
      const userName = user.email.split('@')[0];
      const currencySymbol = getSymbol(baseCurrency);

      const categoryBreakdown = useMemo(() => {
        const breakdown = {};
        transactions.forEach(t => {
          if (t.type !== 'Income') {
            const rate = exchangeRates[t.currency] || 1;
            const baseRate = exchangeRates[baseCurrency] || 1;
            const convertedAmount = t.amount * (rate / baseRate);
            breakdown[t.subcategory] = (breakdown[t.subcategory] || 0) + convertedAmount;
          }
        });
        return Object.entries(breakdown).sort((a,b)=>b[1]-a[1]).slice(0,5);
      }, [transactions, baseCurrency]);

      const handleSignOut = async () => {
        try { await firebase.auth().signOut(); } catch (e) { console.error(e); }
      };

      // New: Generate insights function
      const handleGenerateInsights = async () => {
        if (isGeneratingInsights) return;
        setIsGeneratingInsights(true);
        setInsights([]); // Clear old insights

        try {
            const apiKey = "AIzaSyCEwNa6knQpuCV_eLgKLr7m-88ufWP8484";
            const prompt = `
            You are an expert financial analyst named Clarity. Your job is to analyze the user's financial data and provide three brief, actionable recommendations.
            
            **RULES:**
            1.  Analyze the provided financial data summary.
            2.  Generate exactly three recommendations.
            3.  For each recommendation, provide a "title", a "recommendation" text, and a "type" ('positive', 'negative', or 'neutral').
            4.  Your entire response MUST be ONLY a valid JSON array of three objects, like this:
                [
                  {"type": "negative", "title": "Reduce Dining Expenses", "recommendation": "You spent 15% more on dining this month. Consider meal planning to save money."},
                  {"type": "positive", "title": "Emergency Fund Progress", "recommendation": "Great job! You're on track to reach your emergency fund goal early."},
                  {"type": "neutral", "title": "Investment Opportunity", "recommendation": "You have a monthly surplus. Consider investing in a diversified portfolio."}
                ]
            5.  NEVER output any text, explanation, or conversation. Your entire response must be ONLY the JSON array.

            **USER'S FINANCIAL DATA:**
            ---
            Total Income: ${totals.income} ${baseCurrency}
            Total Expenses: ${totals.expense} ${baseCurrency}
            Net Flow: ${totals.net} ${baseCurrency}
            Transaction Count: ${transactions.length}
            Recent Transactions (JSON): ${JSON.stringify(transactions.slice(0, 15))}
            ---
            `;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] } )
            });

            if (!response.ok) {
                throw new Error("The AI analysis service is currently unavailable.");
            }

            const result = await response.json();
            const rawJsonText = result.candidates[0].content.parts[0].text;
            
            const match = rawJsonText.match(/\[.*\]/s);
            if (!match) {
                throw new Error("The AI returned an invalid format for the insights.");
            }
            
            const parsedInsights = JSON.parse(match[0]);
            setInsights(parsedInsights);

        } catch (error) {
            console.error("Error generating insights:", error);
            // Display a user-friendly error in one of the insight cards
            setInsights([{
                type: 'negative',
                title: 'Error Generating Insights',
                recommendation: `Sorry, I encountered an error: ${error.message}. Please try again.`
            }]);
        } finally {
            setIsGeneratingInsights(false);
        }
      };

      // Importer with accurate parsing
      const handleParseText = async () => {
        if (!pastedText.trim()) { setMessage('Please paste text to import.'); return; }
        setIsParsing(true);
        setMessage('Analyzing with AI...');
        try {
          const apiKey = "AIzaSyCEwNa6knQpuCV_eLgKLr7m-88ufWP8484";
          const prompt = `You are an expert data extraction tool. Your only job is to find and return a valid JSON array of financial transactions from the user's text. Follow these rules strictly:
1.  **Date is CRITICAL.** You MUST convert any date format (e.g., DD/MM/YYYY, MM-DD-YY, Month D, YYYY) into the strict YYYY-MM-DD format. If a transaction has no date, exclude it.
2.  **Amount is CRITICAL.** The 'amount' field must be a number only. You MUST remove any commas, currency symbols, or other non-numeric characters. For example, "$250,000.00" must become 250000.
3.  **Currency is CRITICAL.** Use three-letter codes (USD, AED, etc.).
4.  **Type is CRITICAL.** You must determine if the transaction is 'Income' or an 'Expense' type.
5.  **Your entire response must ONLY be the JSON array.** Do not add any other text.

USER'S TEXT TO PARSE:
---
${pastedText}
---
`;
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
          });
          if (!response.ok) {
            const errorBody = await response.text();
            throw new Error(`AI API Error: ${response.statusText}. Details: ${errorBody}`);
          }
          const result = await response.json();
          const rawJsonText = result.candidates[0].content.parts[0].text;
          const match = rawJsonText.match(/\[.*\]/s);
          if (!match) throw new Error("The AI did not return a valid JSON array. Please check the pasted text format.");

          const parsedTransactions = JSON.parse(match[0]);

          const batch = firebase.firestore().batch();
          const transactionsCollectionRef = firebase.firestore().collection(`users/${user.uid}/transactions`);

          let transactionsAdded = 0;
          parsedTransactions.forEach(transaction => {
            if (transaction.date && !isNaN(new Date(transaction.date)) && transaction.amount) {
              const newRef = transactionsCollectionRef.doc();
              batch.set(newRef, transaction);
              transactionsAdded++;
            }
          });

          if (transactionsAdded === 0) throw new Error("No valid transactions with dates and amounts were found in the provided text.");

          await batch.commit();
          setMessage(`Successfully imported ${transactionsAdded} transactions!`);
          setPastedText('');
        } catch (error) {
          console.error("Error during import:", error);
          setMessage(`Import Error: ${error.message}`);
        } finally {
          setIsParsing(false);
        }
      };

      const showSection = (id) => setActiveSection(id);

      return (
        <div>
          {/* Nav */}
          <nav className="bg-slate-900/50 backdrop-blur-sm border-b border-slate-800 sticky top-0 z-50">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
              <div className="flex justify-between items-center h-16">
                <div className="flex items-center">
                  <div className="text-2xl font-bold gradient-text">Clarity</div>
                </div>
                <div className="hidden md:block">
                  <div className="ml-10 flex items-baseline space-x-4">
                    <button onClick={() => showSection('dashboard')}
                            className={`px-3 py-2 rounded-md text-sm font-medium ${activeSection === 'dashboard' ? 'text-blue-400' : 'text-slate-300 hover:text-white'}`}>
                      Dashboard
                    </button>
                    <button onClick={() => showSection('transactions')}
                            className={`px-3 py-2 rounded-md text-sm font-medium ${activeSection === 'transactions' ? 'text-blue-400' : 'text-slate-300 hover:text-white'}`}>
                      Transactions
                    </button>
                    <button onClick={() => showSection('goals')}
                            className={`px-3 py-2 rounded-md text-sm font-medium ${activeSection === 'goals' ? 'text-blue-400' : 'text-slate-300 hover:text-white'}`}>
                      Goals
                    </button>
                    <button onClick={() => showSection('insights')}
                            className={`px-3 py-2 rounded-md text-sm font-medium ${activeSection === 'insights' ? 'text-blue-400' : 'text-slate-300 hover:text-white'}`}>
                      Insights
                    </button>
                  </div>
                </div>
                <div className="flex items-center space-x-4">
                  <button className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium" onClick={() => showSection('transactions')}>+ Add Transaction</button>
                  <div className="relative">
                    <button onClick={handleSignOut} className="p-2 rounded-full hover:bg-slate-700">
                      <svg className="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </nav>

          {/* Main Content */}
          <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            {/* Dashboard */}
            {activeSection === 'dashboard' && (
              <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                {/* Left Column */}
                <div className="md:col-span-2 space-y-8">
                  {/* Welcome Header */}
                  <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6">
                    <h1 className="text-3xl font-bold text-white mb-2">Welcome back, {userName}!</h1>
                    <p className="text-slate-400">Here's your financial snapshot for this month.</p>
                  </div>

                  {/* Financial Summary */}
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6 card-hover">
                      <div className="flex items-center space-x-3 mb-3">
                        <div className="w-10 h-10 bg-green-500/20 rounded-lg flex items-center justify-center">
                          <svg className="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01"></path></svg>
                        </div>
                        <p className="text-slate-400">Total Income</p>
                      </div>
                      <p className="text-3xl font-bold text-white">{currencySymbol}{totals.income}</p>
                    </div>
                    <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6 card-hover">
                      <div className="flex items-center space-x-3 mb-3">
                        <div className="w-10 h-10 bg-red-500/20 rounded-lg flex items-center justify-center">
                          <svg className="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path></svg>
                        </div>
                        <p className="text-slate-400">Total Expenses</p>
                      </div>
                      <p className="text-3xl font-bold text-white">{currencySymbol}{totals.expense}</p>
                    </div>
                    <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6 card-hover">
                      <div className="flex items-center space-x-3 mb-3">
                        <div className="w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center">
                          <svg className="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h5M20 20v-5h-5"></path><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 9a9 9 0 0114.13-6.36M20 15a9 9 0 01-14.13 6.36"></path></svg>
                        </div>
                        <p className="text-slate-400">Net Flow</p>
                      </div>
                      <p className={`text-3xl font-bold ${totals.net >= 0 ? 'text-green-400' : 'text-red-400'}`}>{currencySymbol}{totals.net}</p>
                    </div>
                  </div>

                  {/* Recent Transactions */}
                  <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-xl font-semibold text-white">Recent Transactions</h3>
                      <button onClick={() => showSection('transactions')} className="text-blue-400 hover:underline text-sm font-medium">View All</button>
                    </div>
                    <div className="space-y-4">
                      {recentTransactions.length > 0 ? recentTransactions.map((transaction) => (
                        <div key={transaction.id} className="flex items-center justify-between">
                          <div className="flex items-center space-x-4">
                            <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${transaction.type === 'Income' ? 'bg-green-500/20' : 'bg-red-500/20'}`}>
                              <span className="text-xl">{transaction.type === 'Income' ? '💰' : '💳'}</span>
                            </div>
                            <div>
                              <p className="font-medium text-white">{transaction.description || transaction.subcategory}</p>
                              <p className="text-sm text-slate-400">{formatDate(transaction.date)}</p>
                            </div>
                          </div>
                          <div className="text-right">
                            <span className={`font-medium ${transaction.type === 'Income' ? 'text-green-400' : 'text-red-400'}`}>
                              {transaction.type === 'Income' ? '+' : '-'}{getSymbol(transaction.currency)}{transaction.amount}
                            </span>
                            <p className="text-xs text-slate-400">{transaction.currency}</p>
                          </div>
                        </div>
                      )) : (
                        <p className="text-slate-400 text-center py-4">No recent transactions.</p>
                      )}
                    </div>
                  </div>
                </div>

                {/* Right Column */}
                <div className="space-y-8">
                  {/* Currency Selector */}
                  <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6">
                    <label htmlFor="currency-select" className="block text-sm font-medium text-slate-400 mb-2">Base Currency</label>
                    <select id="currency-select" value={baseCurrency} onChange={(e) => { setBaseCurrency(e.target.value); localStorage.setItem('userBaseCurrency', e.target.value); }}
                            className="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 focus:ring-2 focus:ring-blue-500 text-white">
                      {currencies.map(c => <option key={c.code} value={c.code}>{c.code} ({c.symbol})</option>)}
                    </select>
                  </div>

                  {/* Category Breakdown */}
                  <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6">
                    <h3 className="text-xl font-semibold text-white mb-4">Spending by Category</h3>
                    <div className="space-y-4">
                      {categoryBreakdown.map(([category, amount]) => (
                        <div key={category}>
                          <div className="flex justify-between text-sm mb-1">
                            <span className="text-slate-300">{category}</span>
                            <span className="text-white font-medium">{currencySymbol}{amount.toFixed(2)}</span>
                          </div>
                          <div className="w-full bg-slate-700 rounded-full h-2">
                            <div className="bg-blue-500 h-2 rounded-full" style={{ width: `${(amount / totals.expense) * 100}%` }}></div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Transactions */}
            {activeSection === 'transactions' && (
              <div>
                <div className="mb-8">
                  <h1 className="text-3xl font-bold text-white mb-2">All Transactions</h1>
                  <p className="text-slate-400">View and manage all your financial transactions</p>
                </div>

                {/* Smart Importer */}
                <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6 mb-8">
                  <div className="flex items-center space-x-3 mb-4">
                    <div className="w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center">
                      <svg className="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                      </svg>
                    </div>
                    <div>
                      <h3 className="text-xl font-semibold text-white">Smart Document Importer</h3>
                      <p className="text-sm text-slate-400">Paste bank statements, receipts, or transaction data to import automatically</p>
                    </div>
                  </div>

                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-slate-300 mb-2">Paste your transaction data below:</label>
                      <textarea value={pastedText} onChange={(e)=>setPastedText(e.target.value)}
                                className="w-full h-32 p-4 bg-slate-800 border border-slate-700 rounded-lg text-white placeholder-slate-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                placeholder="Paste bank statements, receipts, or any transaction text here..." disabled={isParsing}></textarea>
                    </div>
                    <div className="flex justify-between items-center">
                      <div className="flex-1">
                        <p className="text-xs text-slate-500">Supports: Bank statements, credit card statements, receipts, and manual transaction lists</p>
                        {message && (
                          <p className={`text-sm mt-2 ${message.includes('Error') ? 'text-red-400' : message.includes('Successfully') ? 'text-green-400' : 'text-blue-400'}`}>
                            {message}
                          </p>
                        )}
                      </div>
                      <button onClick={handleParseText} disabled={isParsing || !pastedText.trim()}
                              className={`px-6 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2 ${
                                isParsing || !pastedText.trim() ? 'bg-slate-600 text-slate-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 text-white'
                              }`}>
                        {isParsing ? (
                          <>
                            <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                            <span>Processing...</span>
                          </>
                        ) : (
                          <>
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                            </svg>
                            <span>Import Transactions</span>
                          </>
                        )}
                      </button>
                    </div>
                  </div>
                </div>

                {/* History with Edit/Delete buttons */}
                <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6">
                  <div className="flex justify-between items-center mb-6">
                    <h3 className="text-xl font-semibold text-white">Transaction History ({transactions.length})</h3>
                    <div className="flex space-x-2">
                      <button className="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm transition-colors">Filter</button>
                      <button className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">Export</button>
                    </div>
                  </div>

                  <div className="space-y-4">
                    {transactions.length > 0 ? transactions.map((transaction) => (
                      <div key={transaction.id} className="flex items-center justify-between py-4 border-b border-slate-800">
                        <div className="flex items-center space-x-4">
                          <div className={`w-12 h-12 rounded-lg flex items-center justify-center ${transaction.type === 'Income' ? 'bg-green-500/20' : 'bg-red-500/20'}`}>
                            <span className={`${transaction.type === 'Income' ? 'text-green-400' : 'text-red-400'}`}>
                              {transaction.type === 'Income' ? '💰' :
                               transaction.subcategory === 'Groceries' ? '🛒' :
                               transaction.subcategory === 'Transportation' ? '🚗' :
                               transaction.subcategory === 'Entertainment' ? '🎬' :
                               transaction.subcategory === 'Utilities' ? '⚡' : '💳'}
                            </span>
                          </div>
                          <div>
                            <p className="font-medium text-white">{transaction.description || transaction.subcategory}</p>
                            <p className="text-sm text-slate-400">{transaction.subcategory} • {formatDate(transaction.date)}</p>
                          </div>
                        </div>
                        <div className="flex items-center space-x-4">
                          <div className="text-right">
                            <span className={`font-medium text-lg ${transaction.type === 'Income' ? 'text-green-400' : 'text-red-400'}`}>
                              {transaction.type === 'Income' ? '+' : '-'}{getSymbol(transaction.currency)}{transaction.amount}
                            </span>
                            <p className="text-xs text-slate-400">{transaction.currency}</p>
                          </div>
                          <div className="flex space-x-2">
                            <button onClick={() => alert('Edit feature coming soon!')} className="p-2 text-slate-400 hover:text-blue-400 transition-colors">
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path>
                              </svg>
                            </button>
                            <button onClick={() => alert('Delete feature coming soon!')} className="p-2 text-slate-400 hover:text-red-400 transition-colors">
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                              </svg>
                            </button>
                          </div>
                        </div>
                      </div>
                    )) : (
                      <div className="text-center py-12">
                        <div className="text-6xl mb-4">📝</div>
                        <p className="text-xl text-slate-400 mb-2">No transactions yet</p>
                        <p className="text-slate-500">Start tracking your finances by adding your first transaction</p>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}

            {/* Goals */}
            {activeSection === 'goals' && (
              <div>
                <div className="mb-8">
                  <h1 className="text-3xl font-bold text-white mb-2">Financial Goals</h1>
                  <p className="text-slate-400">Track and manage your savings goals</p>
                </div>
                <div className="bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6 mb-8">
                  <div className="flex justify-between items-center mb-6">
                    <h3 className="text-xl font-semibold text-white">Goal Planning</h3>
                    <button className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                      Add New Goal
                    </button>
                  </div>
                  <div className="text-center py-12">
                    <div className="text-6xl mb-4">🎯</div>
                    <p className="text-xl text-slate-400 mb-2">Goals feature coming soon!</p>
                    <p className="text-slate-500">Set and track your financial goals with smart recommendations</p>
                  </div>
                </div>
              </div>
            )}

            {/* Insights (new layout) */}
            {activeSection === 'insights' && (
              <div>
                <div className="mb-8">
                  <h1 className="text-3xl font-bold text-white mb-2">Financial Insights</h1>
                  <p className="text-slate-400">AI-powered insights to improve your financial health</p>
                </div>
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                  {/* Smart Recommendations */}
                  <div className="lg:col-span-2 bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-xl font-semibold text-white">💡 Smart Recommendations</h3>
                      <button
                        onClick={handleGenerateInsights}
                        disabled={isGeneratingInsights}
                        className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center space-x-2 ${
                          isGeneratingInsights ? 'bg-slate-600 text-slate-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 text-white'
                        }`}>
                        {isGeneratingInsights ? (
                          <>
                            <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                            <span>Generating...</span>
                          </>
                        ) : (
                          <span>Generate New Insights</span>
                        )}
                      </button>
                    </div>
                    <div className="space-y-4">
                      {insights.length > 0 ? (
                        insights.map((insight, index) => (
                          <div key={index} className={`border rounded-lg p-4 ${
                            insight.type === 'positive' ? 'bg-green-500/10 border-green-500/20' :
                            insight.type === 'negative' ? 'bg-red-500/10 border-red-500/20' :
                            'bg-blue-500/10 border-blue-500/20'
                          }`}>
                            <h4 className={`font-medium mb-2 ${
                              insight.type === 'positive' ? 'text-green-400' :
                              insight.type === 'negative' ? 'text-red-400' : 'text-blue-400'
                            }`}>{insight.title}</h4>
                            <p className="text-sm text-slate-300">{insight.recommendation}</p>
                          </div>
                        ))
                      ) : (
                        <div className="text-center py-8 text-slate-400">
                          <p>Click "Generate New Insights" to get personalized recommendations from your latest transactions.</p>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Spending Patterns */}
                  <div className="lg:col-span-1 bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6">
                    <h3 className="text-xl font-semibold text-white mb-4">📊 Spending Patterns</h3>
                    <div className="space-y-4">
                      <div className="flex justify-between items-center">
                        <span className="text-slate-300">Highest spending day</span>
                        <span className="text-white font-medium">Friday</span>
                      </div>
                      <div className="flex justify-between items-center">
                        <span className="text-slate-300">Most frequent category</span>
                        <span className="text-white font-medium">Food & Dining</span>
                      </div>
                      <div className="flex justify-between items-center">
                        <span className="text-slate-300">Average transaction</span>
                        <span className="text-white font-medium">$47.32</span>
                      </div>
                      <div className="flex justify-between items-center">
                        <span className="text-slate-300">Monthly trend</span>
                        <span className="text-red-400 font-medium">+8.2% ↗</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </main>
        </div>
      );
    };

    const App = () => {
      const [user, setUser] = useState(null);
      const [isInitializing, setIsInitializing] = useState(true);
      const [error, setError] = useState('');

      useEffect(() => {
        const firebaseConfig = {
          apiKey: "AIzaSyCEwNa6knQpuCV_eLgKLr7m-88ufWP8484",
          authDomain: "financial-wellness-dashboard.firebaseapp.com",
          projectId: "financial-wellness-dashboard",
          storageBucket: "financial-wellness-dashboard.appspot.com",
          messagingSenderId: "599378817258",
          appId: "1:599378817258:web:95841307d6960986f36793"
        };

        try {
          if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
          const unsubscribe = firebase.auth().onAuthStateChanged((currentUser) => {
            setUser(currentUser);
            setIsInitializing(false);
          });
          return () => unsubscribe();
        } catch (err) {
          console.error("Firebase init error:", err);
          setError("Failed to initialize app");
          setIsInitializing(false);
        }
      }, []);

      if (isInitializing) {
        return (
          <div className="flex items-center justify-center min-h-screen bg-slate-950">
            <div className="text-center">
              <div className="text-4xl font-bold gradient-text mb-4">Clarity</div>
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
              <p className="text-slate-400 mt-4">Loading your dashboard...</p>
            </div>
          </div>
        );
      }

      if (error) {
        return (
          <div className="flex items-center justify-center min-h-screen bg-slate-950">
            <div className="text-center">
              <div className="text-red-400 text-xl mb-4">⚠️ Error</div>
              <p className="text-slate-400">{error}</p>
            </div>
          </div>
        );
      }

      return user ? <FinancialDashboard user={user}/> : <LoginPage setError={setError}/>;
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>

