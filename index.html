<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Clarity - Financial Wellness Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <!-- React + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap">
  <style>
    body { font-family: 'DM Sans', sans-serif; }
    .gradient-text {
      background: linear-gradient(to right, #38bdf8, #a78bfa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    /* ---------- pill nav ---------- */
    nav button {
      position: relative;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: #cbd5e1;
      transition: color 0.2s;
    }
    nav button:hover { color: #fff; }
    nav button.active { color: #fff; }
    nav button.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0.5rem;
      right: 0.5rem;
      height: 2px;
      background: #60a5fa;
      border-radius: 9999px;
    }
    /* ---------- glass cards ---------- */
    .glass-card {
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(51, 65, 85, 0.5);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body class="bg-slate-950 text-slate-300">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback, memo } = React;

    /* ----------  CONFIG  ---------- */
    const exchangeRates = { USD: 1, AED: 3.67, EUR: 1.08, GBP: 1.25 };
    const currencies = [
      { code: 'USD', symbol: '$' },
      { code: 'AED', symbol: 'د.إ' },
      { code: 'EUR', symbol: '€' },
      { code: 'GBP', symbol: '£' }
    ];
    const getSymbol = code => currencies.find(c => c.code === code)?.symbol || '';
    const formatDate = d => new Date(d).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

    /* ----------  LOGIN  ---------- */
    const LoginPage = ({ setError }) => {
      const [isLogin, setIsLogin] = useState(true);
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');

      const handleAuthAction = async e => {
        e.preventDefault(); setError('');
        try {
          isLogin
            ? await firebase.auth().signInWithEmailAndPassword(email, password)
            : await firebase.auth().createUserAndPassword(email, password);
        } catch (err) { setError(err.message); }
      };

      return (
        <div className="flex items-center justify-center min-h-screen bg-slate-950">
          <div className="w-full max-w-md p-8 space-y-6 bg-slate-900 rounded-2xl shadow-2xl">
            <div className="text-center">
              <h1 className="text-4xl font-extrabold gradient-text">Clarity</h1>
              <p className="text-slate-400 mt-2">{isLogin ? 'Welcome back, log in to continue' : 'Create an account to get started'}</p>
            </div>
            <form onSubmit={handleAuthAction} className="space-y-6">
              <div>
                <label className="block text-sm font-medium mb-1 text-slate-400">Email Address</label>
                <input type="email" value={email} onChange={e=>setEmail(e.target.value)} required
                       className="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 focus:ring-2 focus:ring-blue-500 text-white"
                       placeholder="you@example.com"/>
              </div>
              <div>
                <label className="block text-sm font-medium mb-1 text-slate-400">Password</label>
                <input type="password" value={password} onChange={e=>setPassword(e.target.value)} required
                       className="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 focus:ring-2 focus:ring-blue-500 text-white"
                       placeholder="••••••••"/>
              </div>
              <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                {isLogin ? 'Login' : 'Sign Up'}
              </button>
            </form>
            <p className="text-center text-sm text-slate-400">
              {isLogin ? "Don't have an account? " : "Already have an account? "}
              <button onClick={()=>{setIsLogin(!isLogin); setError('');}} className="font-medium text-blue-400 hover:underline">
                {isLogin ? 'Sign Up' : 'Login'}
              </button>
            </p>
          </div>
        </div>
      );
    };

    /* ----------  MAIN DASHBOARD  ---------- */
    const FinancialDashboard = ({ user }) => {
      /* ---- memoised input wrappers ---- */
      const FastInput   = memo(({ value, onChange, ...props }) => <input {...props} value={value} onChange={onChange} />);
      const FastTextarea= memo(({ value, onChange, ...props }) => <textarea {...props} value={value} onChange={onChange} />);

      /* ---- state ---- */
      const [transactions, setTransactions] = useState([]);
      const [baseCurrency, setBaseCurrency] = useState(localStorage.getItem('userBaseCurrency')||'USD');
      const [activeSection, setActiveSection] = useState('dashboard');

      // importer
      const [pastedText, setPastedText] = useState('');
      const [isParsing, setIsParsing] = useState(false);
      const [message, setMessage] = useState('');

      // insights + chat
      const [insights, setInsights] = useState([]);
      const [isGeneratingInsights, setIsGeneratingInsights] = useState(false);
      const [chatMessages, setChatMessages] = useState([]);
      const [chatInput, setChatInput] = useState('');
      const [isChatLoading, setIsChatLoading] = useState(false);

      // goals
      const [goals, setGoals] = useState([]);
      const [futureExpenses, setFutureExpenses] = useState([]);
      const [showAddGoal, setShowAddGoal] = useState(false);
      const [showAddExpense, setShowAddExpense] = useState(false);
      const [newGoal, setNewGoal] = useState({ name:'',target:'',deadline:'',saved:0 });
      const [newExpense, setNewExpense] = useState({ name:'',amount:'',date:'',category:'School Fees' });

      // monthly
      const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0,7));
      const [monthlyInsights, setMonthlyInsights] = useState('');
      const [isAnalyzingMonth, setIsAnalyzingMonth] = useState(false);

      /* ---- firestore subs ---- */
      useEffect(()=>{
        if(!user) return;
        const txRef = firebase.firestore().collection(`users/${user.uid}/transactions`);
        const gRef  = firebase.firestore().collection(`users/${user.uid}/goals`);
        const feRef = firebase.firestore().collection(`users/${user.uid}/futureExpenses`);
        const uns = [
          txRef.onSnapshot(snap=>{
            const list = snap.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>new Date(b.date)-new Date(a.date));
            setTransactions(list);
          }),
          gRef.onSnapshot(s=>setGoals(s.docs.map(d=>({id:d.id,...d.data()})))),
          feRef.onSnapshot(s=>setFutureExpenses(s.docs.map(d=>({id:d.id,...d.data()}))))
        ];
        return ()=>uns.forEach(u=>u());
      },[user]);

      /* ---- calculations ---- */
      const totals = useMemo(()=>{
        let inc=0, exp=0;
        transactions.forEach(t=>{
          const r = exchangeRates[t.currency]||1, br = exchangeRates[baseCurrency]||1;
          const amt = t.amount*(r/br);
          t.type==='Income'?inc+=amt:exp+=amt;
        });
        return {income:inc.toFixed(2), expense:exp.toFixed(2), net:(inc-exp).toFixed(2)};
      },[transactions,baseCurrency]);

      const getMonthlyTransactions = useMemo(()=>{
        const g={};
        transactions.forEach(t=>{
          const m=t.date.slice(0,7);
          (g[m]||(g[m]=[])).push(t);
        });
        return g;
      },[transactions]);

      const getMonthlyTotals = monthTx=>{
        let inc=0, exp=0;
        monthTx.forEach(t=>{
          const r=exchangeRates[t.currency]||1, br=exchangeRates[baseCurrency]||1;
          const amt=t.amount*(r/br);
          t.type==='Income'?inc+=amt:exp+=amt;
        });
        return {income:inc.toFixed(2), expense:exp.toFixed(2), net:(inc-exp).toFixed(2)};
      };

      const categoryBreakdown = useMemo(()=>{
        const b={};
        transactions.forEach(t=>{
          if(t.type!=='Income'){
            const r=exchangeRates[t.currency]||1, br=exchangeRates[baseCurrency]||1;
            const amt=t.amount*(r/br);
            b[t.subcategory]=(b[t.subcategory]||0)+amt;
          }
        });
        return Object.entries(b).sort((a,b)=>b[1]-a[1]).slice(0,5);
      },[transactions,baseCurrency]);

      /* ---- helpers ---- */
      const handleSignOut = async ()=>{try{await firebase.auth().signOut()}catch(e){console.error(e)}};
      const handleDeleteTransaction = async id=>{
        if(!confirm('Are you sure you want to delete this transaction?')) return;
        try{await firebase.firestore().collection(`users/${user.uid}/transactions`).doc(id).delete()}
        catch(e){console.error(e);alert('Failed to delete transaction.');}
      };

      /* ---- stable input handlers (fix lag) ---- */
      const setGoalField    = useCallback((f,v)=>setNewGoal(g=>({...g,[f]:v})),[]);
      const setExpenseField = useCallback((f,v)=>setNewExpense(e=>({...e,[f]:v})),[]);

      /* ---- AI functions ---- */
      const handleParseText = async ()=>{
        if(!pastedText.trim()){setMessage('Paste text to import.');return;}
        setIsParsing(true);setMessage('Analyzing with AI...');
        try{
          const apiKey="AIzaSyCEwNa6knQpuCV_eLgKLr7m-88ufWP8484";
          const prompt=`Extract JSON array of transactions (fields: date YYYY-MM-DD, amount number, currency 3-letter, type Income/Expense, subcategory). Remove symbols from amount.`;
          const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({contents:[{parts:[{text:prompt+'\n---\n'+pastedText+'\n---'}]}]})
          });
          if(!res.ok) throw new Error('AI API error');
          const raw=(await res.json()).candidates[0].content.parts[0].text;
          const arr=JSON.parse(raw.match(/\[.*\]/s)[0]);
          const batch=firebase.firestore().batch(), col=firebase.firestore().collection(`users/${user.uid}/transactions`);
          let c=0; arr.forEach(tx=>{if(tx.date&&!isNaN(new Date(tx.date))&&tx.amount){batch.set(col.doc(),tx);c++;}});
          if(!c) throw new Error('No valid transactions');
          await batch.commit(); setMessage(`Imported ${c} transactions!`); setPastedText('');
        }catch(e){setMessage(`Import Error: ${e.message}`);}
        finally{setIsParsing(false);}
      };

      const handleGenerateInsights = async ()=>{
        if(isGeneratingInsights) return;
        setIsGeneratingInsights(true);setInsights([]);
        try{
          const apiKey="AIzaSyCEwNa6knQpuCV_eLgKLr7m-88ufWP8484";
          const prompt=`You are Clarity. Give exactly 3 brief actionable recommendations (title,recommendation,type) under 100 chars each. Data: Income ${totals.income} ${baseCurrency}, Expenses ${totals.expense} ${baseCurrency}, Net ${totals.net} ${baseCurrency}, Recent ${JSON.stringify(transactions.slice(0,10))}. Respond ONLY JSON array.`;
          const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})
          });
          const raw=(await res.json()).candidates[0].content.parts[0].text;
          const arr=JSON.parse(raw.match(/\[.*\]/s)[0]);
          if(!Array.isArray(arr)||arr.length!==3) throw new Error('Bad AI response');
          setInsights(arr);
        }catch(e){setInsights([{type:'negative',title:'Analysis Error',recommendation:`Unable to generate insights: ${e.message}`}]);}
        finally{setIsGeneratingInsights(false);}
      };

      const handleSendChatMessage = async ()=>{
        if(!chatInput.trim()||isChatLoading) return;
        const msg=chatInput.trim(); setChatInput(''); setChatMessages(p=>[...p,{type:'user',message:msg}]); setIsChatLoading(true);
        try{
          const apiKey="AIzaSyCEwNa6knQpuCV_eLgKLr7m-88ufWP8484";
          const prompt=`You are Clarity, a financial advisor. Answer: "${msg}". User data: Income ${totals.income} ${baseCurrency}, Expenses ${totals.expense} ${baseCurrency}, Recent ${JSON.stringify(transactions.slice(0,10))}. Keep under 100 words.`;
          const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})
          });
          const ai=(await res.json()).candidates[0].content.parts[0].text;
          setChatMessages(p=>[...p,{type:'ai',message:ai}]);
        }catch{setChatMessages(p=>[...p,{type:'ai',message:'Sorry, I encountered an error.'}]);}
        finally{setIsChatLoading(false);}
      };

      const analyzeMonth = async month=>{
        setIsAnalyzingMonth(true);
        const monthTx=getMonthlyTransactions[month]||[];
        const mt=getMonthlyTotals(monthTx);
        try{
          const apiKey="AIzaSyCEwNa6knQpuCV_eLgKLr7m-88ufWP8484";
          const prompt=`Analyze ${month} spending. Income ${mt.income} ${baseCurrency}, Expenses ${mt.expense} ${baseCurrency}, Net ${mt.net} ${baseCurrency}. Transactions ${JSON.stringify(monthTx.slice(0,20))}. Give 2 sentences and 1 tip.`;
          const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})
          });
          setMonthlyInsights((await res.json()).candidates[0].content.parts[0].text);
        }catch{setMonthlyInsights('Unable to analyze this month.');}
        finally{setIsAnalyzingMonth(false);}
      };

      /* ---- goals handlers ---- */
      const handleAddGoal = async()=>{
        if(!newGoal.name||!newGoal.target||!newGoal.deadline) return;
        await firebase.firestore().collection(`users/${user.uid}/goals`).add({...newGoal,target:parseFloat(newGoal.target),createdAt:new Date()});
        setNewGoal({name:'',target:'',deadline:'',saved:0}); setShowAddGoal(false);
      };
      const handleAddExpense = async()=>{
        if(!newExpense.name||!newExpense.amount||!newExpense.date) return;
        await firebase.firestore().collection(`users/${user.uid}/futureExpenses`).add({...newExpense,amount:parseFloat(newExpense.amount),createdAt:new Date()});
        setNewExpense({name:'',amount:'',date:'',category:'School Fees'}); setShowAddExpense(false);
      };

      /* ---- render helpers ---- */
      const symbol=getSymbol(baseCurrency);
      const recent=transactions.slice(0,5);

      /* ----------  SECTIONS  ---------- */
      const Dashboard=()=>(
        <div className="glass-card">
          <div className="mb-8"><h1 className="text-3xl font-bold text-white mb-2">Welcome back, {user.email.split('@')[0]}! 👋</h1><p className="text-slate-400">Here's your financial overview</p></div>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div className="glass-card"><div className="flex items-center justify-between"><div className="flex-1"><div className="flex items-center justify-between mb-2"><p className="text-slate-400 text-sm font-medium">Net Balance</p><select value={baseCurrency} onChange={e=>{setBaseCurrency(e.target.value);localStorage.setItem('userBaseCurrency',e.target.value)}} className="bg-slate-800 border border-slate-700 text-white text-xs px-2 py-1 rounded">{currencies.map(c=><option key={c.code} value={c.code}>{c.symbol} {c.code}</option>)}</select></div><p className="text-2xl font-bold text-white">{symbol}{totals.net}</p><p className={`text-sm mt-1 ${parseFloat(totals.net)>=0?'text-green-400':'text-red-400'}`}>{parseFloat(totals.net)>=0?'Positive':'Negative'} balance</p></div><div className="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center ml-4"><svg className="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path></svg></div></div></div>
            <div className="glass-card"><div className="flex items-center justify-between"><div><p className="text-slate-400 text-sm font-medium">Total Expenses</p><p className="text-2xl font-bold text-white">{symbol}{totals.expense}</p><p className="text-red-400 text-sm mt-1">{transactions.filter(t=>t.type!=='Income').length} transactions</p></div><div className="w-12 h-12 bg-red-500/20 rounded-lg flex items-center justify-center"><svg className="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path></svg></div></div></div>
            <div className="glass-card"><div className="flex items-center justify-between"><div><p className="text-slate-400 text-sm font-medium">Total Income</p><p className="text-2xl font-bold text-white">{symbol}{totals.income}</p><p className="text-green-400 text-sm mt-1">{transactions.filter(t=>t.type==='Income').length} transactions</p></div><div className="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center"><svg className="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path></svg></div></div></div>
            <div className="glass-card"><div className="flex items-center justify-between"><div><p className="text-slate-400 text-sm font-medium">Total Transactions</p><p className="text-2xl font-bold text-white">{transactions.length}</p><p className="text-purple-400 text-sm mt-1">All time</p></div><div className="w-12 h-12 bg-purple-500/20 rounded-lg flex items-center justify-center"><svg className="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg></div></div></div>
          </div>
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div className="glass-card"><h3 className="text-xl font-semibold text-white mb-4">Recent Activity</h3><div className="h-48 flex items-center justify-center"><div className="text-center"><div className="text-4xl mb-4">📊</div><p className="text-slate-400">Visual charts coming soon!</p><p className="text-sm text-slate-500 mt-2">Your data is being tracked</p></div></div></div>
            <div className="glass-card"><h3 className="text-xl font-semibold text-white mb-4">Top Spending Categories</h3><div className="space-y-3">{categoryBreakdown.length>0?categoryBreakdown.map(([cat,amt],i)=><div key={cat} className="flex items-center justify-between"><div className="flex items-center space-x-3"><div className={`w-3 h-3 rounded-full ${i===0?'bg-blue-400':i===1?'bg-purple-400':i===2?'bg-pink-400':i===3?'bg-green-400':'bg-yellow-400'}`}></div><span className="text-sm text-slate-300">{cat}</span></div><span className="text-sm text-white">{symbol}{amt.toFixed(2)}</span></div>):<div className="text-center py-8"><p className="text-slate-400">No expense data yet</p><p className="text-sm text-slate-500 mt-1">Start adding transactions to see breakdown</p></div>}</div></div>
          </div>
          <div className="glass-card"><div className="flex justify-between items-center mb-6"><h3 className="text-xl font-semibold text-white">Recent Transactions</h3><button onClick={()=>setActiveSection('transactions')} className="text-blue-400 hover:text-blue-300 text-sm font-medium">View All</button></div><div className="space-y-4">{recent.length>0?recent.map(tx=><div key={tx.id} className="flex items-center justify-between py-3 border-b border-slate-800"><div className="flex items-center space-x-3"><div className={`w-10 h-10 rounded-lg flex items-center justify-center ${tx.type==='Income'?'bg-green-500/20':'bg-red-500/20'}`}><span className={`text-sm ${tx.type==='Income'?'text-green-400':'text-red-400'}`}>{tx.type==='Income'?'💰':tx.subcategory==='Groceries'?'🛒':tx.subcategory==='Transportation'?'🚗':tx.subcategory==='Entertainment'?'🎬':tx.subcategory==='Utilities'?'⚡':'💳'}</span></div><div><p className="font-medium text-white">{tx.description||tx.subcategory}</p><p className="text-sm text-slate-400">{formatDate(tx.date)}</p></div></div><span className={`font-medium ${tx.type==='Income'?'text-green-400':'text-red-400'}`}>{tx.type==='Income'?'+':'-'}{getSymbol(tx.currency)}{tx.amount}</span></div>):<div className="text-center py-8"><div className="text-4xl mb-4">📝</div><p className="text-slate-400">No transactions yet</p><p className="text-sm text-slate-500 mt-1">Your transactions will appear here</p></div>}</div></div>
        </div>
      );

      const Transactions=()=>(
        <div className="glass-card">
          <div className="mb-8"><h1 className="text-3xl font-bold text-white mb-2">All Transactions</h1><p className="text-slate-400">View and manage all your financial transactions</p></div>
          <div className="glass-card mb-8">
            <div className="flex items-center space-x-3 mb-4"><div className="w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center"><svg className="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path></svg></div><div><h3 className="text-xl font-semibold text-white">Smart Document Importer</h3><p className="text-sm text-slate-400">Paste bank statements, receipts, or transaction data to import automatically</p></div></div>
            <div className="space-y-4"><div><label className="block text-sm font-medium text-slate-300 mb-2">Paste your transaction data below:</label><FastTextarea value={pastedText} onChange={e=>setPastedText(e.target.value)} className="w-full h-32 p-4 bg-slate-800 border border-slate-700 rounded-lg text-white placeholder-slate-400 resize-none" placeholder="Paste bank statements, receipts, or any transaction text here..." disabled={isParsing}></FastTextarea></div><div className="flex justify-between items-center"><div className="flex-1"><p className="text-xs text-slate-500">Supports: Bank statements, credit card statements, receipts, and manual transaction lists</p>{message&&<p className={`text-sm mt-2 ${message.includes('Error')?'text-red-400':message.includes('Successfully')?'text-green-400':'text-blue-400'}`}>{message}</p>}</div><button onClick={handleParseText} disabled={isParsing||!pastedText.trim()} className={`px-6 py-2 rounded-lg font-medium flex items-center space-x-2 ${isParsing||!pastedText.trim()?'bg-slate-600 text-slate-400 cursor-not-allowed':'bg-blue-600 hover:bg-blue-700 text-white'}`}>{isParsing?<> <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div><span>Processing...</span></>:<> <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg><span>Import Transactions</span></>}</button></div></div>
          </div>
          <div className="glass-card">
            <div className="flex justify-between items-center mb-6"><h3 className="text-xl font-semibold text-white">Transaction History ({transactions.length})</h3><div className="flex space-x-2"><select value={selectedMonth} onChange={e=>setSelectedMonth(e.target.value)} className="bg-slate-700 border border-slate-600 text-white px-3 py-2 rounded-lg text-sm">{[<option key="" value="">All Months</option>,...Object.keys(getMonthlyTransactions).sort().reverse().map(m=><option key={m} value={m}>{new Date(m+'-01').toLocaleDateString('en-US',{year:'numeric',month:'long'})}</option>)]}</select><button className="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm">Filter</button><button className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">Export</button></div></div>
            {selectedMonth&&getMonthlyTransactions[selectedMonth]&&<div className="mb-6 p-4 bg-slate-800 rounded-lg"><div className="flex justify-between items-center mb-4"><h4 className="text-lg font-semibold text-white">{new Date(selectedMonth+'-01').toLocaleDateString('en-US',{year:'numeric',month:'long'})} Summary</h4><button onClick={()=>analyzeMonth(selectedMonth)} disabled={isAnalyzingMonth} className="bg-purple-600 hover:bg-purple-700 disabled:bg-slate-600 text-white px-3 py-1 rounded text-sm">{isAnalyzingMonth?'Analyzing...':'AI Analysis'}</button></div>{(function(){const mt=getMonthlyTotals(getMonthlyTransactions[selectedMonth]); return <div className="grid grid-cols-3 gap-4 mb-4"><div className="text-center"><p className="text-slate-400 text-sm">Income</p><p className="text-green-400 font-semibold">{symbol}{mt.income}</p></div><div className="text-center"><p className="text-slate-400 text-sm">Expenses</p><p className="text-red-400 font-semibold">{symbol}{mt.expense}</p></div><div className="text-center"><p className="text-slate-400 text-sm">Net</p><p className={`font-semibold ${parseFloat(mt.net)>=0?'text-green-400':'text-red-400'}`}>{symbol}{mt.net}</p></div></div>})()}{monthlyInsights&&<div className="p-3 bg-slate-700 rounded-lg"><p className="text-slate-300 text-sm">{monthlyInsights}</p></div>}</div>}
            <div className="space-y-4">{(function(){const list=selectedMonth?getMonthlyTransactions[selectedMonth]||[]:transactions; return list.length>0?list.map(tx=><div key={tx.id} className="flex items-center justify-between py-4 border-b border-slate-800"><div className="flex items-center space-x-4"><div className={`w-12 h-12 rounded-lg flex items-center justify-center ${tx.type==='Income'?'bg-green-500/20':'bg-red-500/20'}`}><span className={`${tx.type==='Income'?'text-green-400':'text-red-400'}`}>{tx.type==='Income'?'💰':tx.subcategory==='Groceries'?'🛒':tx.subcategory==='Transportation'?'🚗':tx.subcategory==='Entertainment'?'🎬':tx.subcategory==='Utilities'?'⚡':'💳'}</span></div><div><p className="font-medium text-white">{tx.description||tx.subcategory}</p><p className="text-sm text-slate-400">{tx.subcategory} • {formatDate(tx.date)}</p></div></div><div className="flex items-center space-x-4"><div className="text-right"><span className={`font-medium text-lg ${tx.type==='Income'?'text-green-400':'text-red-400'}`}>{tx.type==='Income'?'+':'-'}{getSymbol(tx.currency)}{tx.amount}</span><p className="text-xs text-slate-400">{tx.currency}</p></div><div className="flex space-x-2"><button onClick={()=>alert('Edit feature coming soon!')} className="p-2 text-slate-400 hover:text-blue-400"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg></button><button onClick={()=>handleDeleteTransaction(tx.id)} className="p-2 text-slate-400 hover:text-red-400"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div></div></div>):<div className="text-center py-12"><div className="text-6xl mb-4">📝</div><p className="text-xl text-slate-400 mb-2">No transactions for this period</p><p className="text-slate-500">Try selecting a different month or add new transactions</p></div>})()}</div>
          </div>
        </div>
      );

      const Goals=()=>(
        <div className="glass-card">
          <div className="mb-8"><h1 className="text-3xl font-bold text-white mb-2">Financial Goals</h1><p className="text-slate-400">Track savings goals and plan future expenses</p></div>
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div className="glass-card">
              <div className="flex justify-between items-center mb-6"><h3 className="text-xl font-semibold text-white">🎯 Savings Goals</h3><button onClick={()=>setShowAddGoal(true)} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium">Add Goal</button></div>
              {showAddGoal&&<div className="mb-6 p-4 bg-slate-800 rounded-lg"><h4 className="text-white font-medium mb-3">Add New Goal</h4><div className="space-y-3"><FastInput value={newGoal.name} onChange={e=>setGoalField('name',e.target.value)} placeholder="Goal name (e.g., Emergency Fund)" className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-white"/><FastInput value={newGoal.target} onChange={e=>setGoalField('target',e.target.value)} placeholder="Target amount" type="number" className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-white"/><FastInput value={newGoal.deadline} onChange={e=>setGoalField('deadline',e.target.value)} type="date" className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-white"/><div className="flex space-x-2"><button onClick={handleAddGoal} className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">Save</button><button onClick={()=>setShowAddGoal(false)} className="bg-slate-600 hover:bg-slate-700 text-white px-4 py-2 rounded text-sm">Cancel</button></div></div></div>}
              <div className="space-y-4">{goals.length>0?goals.map(g=><div key={g.id} className="p-4 bg-slate-800 rounded-lg"><div className="flex justify-between items-center mb-2"><h4 className="text-white font-medium">{g.name}</h4><span className="text-slate-400 text-sm">{new Date(g.deadline).toLocaleDateString()}</span></div><div className="mb-2"><div className="flex justify-between text-sm mb-1"><span className="text-slate-400">Progress</span><span className="text-white">{symbol}{g.saved} / {symbol}{g.target}</span></div><div className="w-full bg-slate-700 rounded-full h-2"><div className="bg-blue-600 h-2 rounded-full" style={{width:`${Math.min((g.saved/g.target)*100,100)}%`}}></div></div></div><p className="text-xs text-slate-400">{((g.saved/g.target)*100).toFixed(1)}% complete</p></div>):<div className="text-center py-8 text-slate-400"><p>No goals yet. Add your first savings goal!</p></div>}</div>
            </div>
            <div className="glass-card">
              <div className="flex justify-between items-center mb-6"><h3 className="text-xl font-semibold text-white">📅 Future Expenses</h3><button onClick={()=>setShowAddExpense(true)} className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium">Plan Expense</button></div>
              {showAddExpense&&<div className="mb-6 p-4 bg-slate-800 rounded-lg"><h4 className="text-white font-medium mb-3">Plan Future Expense</h4><div className="space-y-3"><FastInput value={newExpense.name} onChange={e=>setExpenseField('name',e.target.value)} placeholder="Expense name" className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-white"/><FastInput value={newExpense.amount} onChange={e=>setExpenseField('amount',e.target.value)} placeholder="Amount" type="number" className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-white"/><FastInput value={newExpense.date} onChange={e=>setExpenseField('date',e.target.value)} type="date" className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-white"/><select value={newExpense.category} onChange={e=>setExpenseField('category',e.target.value)} className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-white"><option>School Fees</option><option>Rent</option><option>Vacation</option><option>Insurance</option><option>Medical</option><option>Other</option></select><div className="flex space-x-2"><button onClick={handleAddExpense} className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">Save</button><button onClick={()=>setShowAddExpense(false)} className="bg-slate-600 hover:bg-slate-700 text-white px-4 py-2 rounded text-sm">Cancel</button></div></div></div>}
              <div className="space-y-4">{futureExpenses.length>0?futureExpenses.map(e=><div key={e.id} className="p-4 bg-slate-800 rounded-lg"><div className="flex justify-between items-center mb-2"><h4 className="text-white font-medium">{e.name}</h4><span className="text-purple-400 font-medium">{symbol}{e.amount}</span></div><div className="flex justify-between items-center"><span className="text-slate-400 text-sm">{e.category}</span><span className="text-slate-400 text-sm">{new Date(e.date).toLocaleDateString()}</span></div></div>):<div className="text-center py-8 text-slate-400"><p>No planned expenses. Start planning ahead!</p></div>}</div>
            </div>
          </div>
        </div>
      );

      const Insights=()=>(
        <div className="glass-card">
          <div className="mb-8"><h1 className="text-3xl font-bold text-white mb-2">Financial Insights</h1><p className="text-slate-400">AI-powered insights to improve your financial health</p></div>
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <div className="lg:col-span-2 glass-card">
              <div className="flex justify-between items-center mb-4"><h3 className="text-xl font-semibold text-white">💡 Smart Recommendations</h3><button onClick={handleGenerateInsights} disabled={isGeneratingInsights} className={`px-4 py-2 rounded-lg text-sm font-medium flex items-center space-x-2 ${isGeneratingInsights?'bg-slate-600 text-slate-400 cursor-not-allowed':'bg-blue-600 hover:bg-blue-700 text-white'}`}>{isGeneratingInsights?<> <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div><span>Generating...</span></>:<span>Generate New Insights</span>}</button></div>
              <div className="space-y-4 mb-6">{insights.length>0?insights.map((ins,i)=><div key={i} className={`border rounded-lg p-4 ${ins.type==='positive'?'bg-green-500/10 border-green-500/20':ins.type==='negative'?'bg-red-500/10 border-red-500/20':'bg-blue-500/10 border-blue-500/20'}`}><h4 className={`font-medium mb-2 ${ins.type==='positive'?'text-green-400':ins.type==='negative'?'text-red-400':'text-blue-400'}`}>{ins.title}</h4><p className="text-sm text-slate-300">{ins.recommendation}</p></div>):<div className="text-center py-8 text-slate-400"><p>Click "Generate New Insights" to get personalized recommendations.</p></div>}</div>
              <div className="border-t border-slate-700 pt-6"><h4 className="text-lg font-semibold text-white mb-4">🤖 Ask Clarity</h4><div className="bg-slate-800 rounded-lg p-4 h-64 overflow-y-auto mb-4">{chatMessages.length>0?chatMessages.map((m,i)=><div key={i} className={`mb-3 ${m.type==='user'?'text-right':'text-left'}`}><div className={`inline-block p-3 rounded-lg max-w-xs ${m.type==='user'?'bg-blue-600 text-white':'bg-slate-700 text-slate-200'}`}><p className="text-sm">{m.message}</p></div></div>):<p className="text-slate-400 text-center">Ask me anything about your finances!</p>}{isChatLoading&&<div className="text-left mb-3"><div className="inline-block p-3 rounded-lg bg-slate-700"><div className="animate-pulse text-slate-400">Thinking...</div></div></div>}</div><div className="flex space-x-2"><FastInput value={chatInput} onChange={e=>setChatInput(e.target.value)} onKeyPress={e=>e.key==='Enter'&&handleSendChatMessage()} placeholder="Ask about your spending, savings, or financial goals..." className="flex-1 p-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:ring-2 focus:ring-blue-500"/><button onClick={handleSendChatMessage} disabled={!chatInput.trim()||isChatLoading} className="px-4 py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-600 text-white rounded-lg transition-colors">Send</button></div></div>
            </div>
            <div className="glass-card"><h3 className="text-xl font-semibold text-white mb-4">📊 Spending Patterns</h3><div className="space-y-4"><div className="flex justify-between items-center"><span className="text-slate-300">Highest spending day</span><span className="text-white font-medium">Friday</span></div><div className="flex justify-between items-center"><span className="text-slate-300">Most frequent category</span><span className="text-white font-medium">Food & Dining</span></div><div className="flex justify-between items-center"><span className="text-slate-300">Average transaction</span><span className="text-white font-medium">$47.32</span></div><div className="flex justify-between items-center"><span className="text-slate-300">Monthly trend</span><span className="text-red-400 font-medium">+8.2% ↗</span></div></div></div>
          </div>
        </div>
      );

      /* ----------  MAIN RENDER  ---------- */
      return (
        <div>
          <nav className="bg-slate-900/50 backdrop-blur-sm border-b border-slate-800 sticky top-0 z-50">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
              <div className="flex justify-between items-center h-16">
                <div className="flex items-center"><div className="text-2xl font-bold gradient-text">Clarity</div></div>
                <div className="hidden md:block"><div className="ml-10 flex items-baseline space-x-4">
                  {['dashboard','transactions','goals','insights'].map(s=><button key={s} onClick={()=>setActiveSection(s)} className={`${activeSection===s?'active':''}`}>{s.charAt(0).toUpperCase()+s.slice(1)}</button>)}
                </div></div>
                <div className="flex items-center space-x-4"><button className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium">Connect Bank</button><button onClick={handleSignOut} className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium">Sign Out</button><div className="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full"></div></div>
              </div>
            </div>
          </nav>
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            {activeSection==='dashboard'&&<Dashboard/>}
            {activeSection==='transactions'&&<Transactions/>}
            {activeSection==='goals'&&<Goals/>}
            {activeSection==='insights'&&<Insights/>}
          </div>
        </div>
      );
    };

    /* ----------  APP / AUTH  ---------- */
    const App = () => {
      const [user, setUser] = useState(null);
      const [error, setError] = useState('');

      useEffect(()=>{
        const firebaseConfig = {
          apiKey: "AIzaSyCEwNa6knQpuCV_eLgKLr7m-88ufWP8484",
          authDomain: "financial-wellness-dashboard.firebaseapp.com",
          projectId: "financial-wellness-dashboard",
          storageBucket: "financial-wellness-dashboard.appspot.com",
          messagingSenderId: "599378817258",
          appId: "1:599378817258:web:95841307d6960986f36793"
        };
        firebase.initializeApp(firebaseConfig);
        return firebase.auth().onAuthStateChanged(setUser);
      },[]);

      return user ? <FinancialDashboard user={user}/> : <LoginPage setError={setError}/>;
    };

    ReactDOM.render(<App/>, document.getElementById('root'));
  </script>
</body>
</html>
